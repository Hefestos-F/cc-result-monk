<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="theme-color" content="#121212" />
    <title>Exaustor Monitor</title>

    <!-- CSP b√°sica; ajuste se servir Chart.js local -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   connect-src 'self' ws: wss:;
                   img-src 'self' data:;
                   style-src 'self' 'unsafe-inline';
                   script-src 'self' https://cdn.jsdelivr.net;
                   object-src 'none';
                   base-uri 'self';
                   frame-ancestors 'none'">

    /manifest.webmanifest
    /icons/favicon-16.png
    /icons/favicon-32.png
    /icons/apple-180.png

    https://cdn.jsdelivr.net/npm/chart.js</script>

    <style>
      /* (estilos principais ‚Äì resumidos por brevidade) */
      *, *::before, *::after { box-sizing: border-box; }
      :root{ --bg:#121212; --surface:#1e1e1e; --surface-2:#2c2c2c; --text:#fff; --muted:#b5b5b5;
             --primary:#4caf50; --primary-hover:#45a049; --danger:#ff5c5c; --warning:#ff9800; --info:#2196f3;
             --shadow:0 0 10px rgba(0,0,0,.6); --radius:12px; --space-1:.5rem; --space-2:.75rem; --space-3:1rem; --space-4:1.25rem; --space-5:1.75rem;
             --toast-bg:#2a2a2a; --toast-text:#fff; --toast-border-info:var(--info); --toast-border-success:var(--primary);
             --toast-border-warn:var(--warning); --toast-border-error:var(--danger);}
      :root[data-theme="light"]{ --bg:#f5f7fb; --surface:#fff; --surface-2:#f0f3f9; --text:#101214; --muted:#49545c;
             --primary:#2e7d32; --primary-hover:#256428; --danger:#d32f2f; --warning:#ed6c02; --info:#1565c0; --shadow:0 4px 14px rgba(0,0,0,.08);
             --toast-bg:#fff; --toast-text:#101214; }
      body{ margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
      .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
      header.header{ display:flex; justify-content:space-between; align-items:center; padding:var(--space-3) var(--space-4); background:var(--surface); position:sticky; top:0; z-index:10; box-shadow:var(--shadow); }
      header .title{ display:flex; align-items:center; gap:.6rem; font-size:1.25rem; font-weight:600; }
      header .actions{ display:flex; gap:.5rem; align-items:center; }
      .conn-dot{ width:10px; height:10px; border-radius:50%; background:#888; box-shadow:0 0 0 2px #0003 inset; }
      .conn-dot.is-ok{ background:#4caf50; } .conn-dot.is-warn{ background:#ff9800; } .conn-dot.is-bad{ background:#ff5c5c; }
      .btn{ padding:.55rem .9rem; background:var(--primary); border:none; border-radius:8px; color:#fff; cursor:pointer; line-height:1; font-weight:600; }
      .btn:hover{ background:var(--primary-hover); } .btn:focus-visible{ outline:3px solid #76d47a; outline-offset:2px; }
      .btn--ghost{ background:transparent; border:1px solid var(--surface-2); color:var(--text); } .btn-icon{ display:inline-flex; align-items:center; gap:.5rem; }
      .btn-icon svg{ width:18px; height:18px; } .hide{ display:none !important; }
      main{ padding:var(--space-4) var(--space-3); max-width:1100px; margin:0 auto; }
      .cards{ display:grid; gap:var(--space-3); grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); margin-bottom:var(--space-4); }
      .card{ background:var(--surface); padding:var(--space-4); border-radius:var(--radius); box-shadow:var(--shadow); }
      .card h2{ margin:0 0 .5rem 0; font-size:1.1rem; } .muted{ color:var(--muted); }
      .status-row{ display:flex; justify-content:center; gap:.75rem; align-items:center; flex-wrap:wrap; }
      .chart-grid{ display:grid; gap:var(--space-3); grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); }
      .chart-box{ background:var(--surface-2); padding:var(--space-3); border-radius:var(--radius); box-shadow:var(--shadow); height:240px; }
      .alert{ color:#ff6b6b; font-weight:700; min-height:1.2em; }
      .config-panel[hidden]{ display:none; }
      .config-panel{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:grid; place-items:start center; padding-top:6vh; z-index:50; }
      .config-content{ background:var(--surface); width:min(92vw,580px); border-radius:var(--radius); padding:var(--space-4); box-shadow:var(--shadow); }
      .config-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-3); }
      .tabs{ display:flex; gap:.4rem; flex-wrap:wrap; }
      .tab{ padding:.55rem .8rem; border-radius:8px; background:var(--surface-2); border:1px solid transparent; color:var(--text); cursor:pointer; }
      .tab[aria-selected="true"]{ background:var(--primary); }
      .tab-content{ display:none; margin-top:var(--space-3); } .tab-content.active{ display:block; }
      fieldset{ border:1px solid #3335; border-radius:10px; padding:var(--space-3); margin-bottom:var(--space-3); }
      legend{ padding:0 .4rem; color:var(--muted); }
      label{ display:block; text-align:left; margin:.4rem 0 .2rem; }
      input, select{ width:100%; padding:.7rem .8rem; border-radius:8px; border:1px solid #3a3a3a; background:var(--surface-2); color:var(--text); }
      input::placeholder{ color:#9a9a9a; }
      .row{ display:grid; grid-template-columns:1fr; gap:.6rem; }
      .row-2{ display:grid; grid-template-columns:repeat(2,1fr); gap:.6rem; }
      .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:.6rem; }
      .form-actions{ display:flex; justify-content:flex-end; gap:.5rem; margin-top:.6rem; }
      .dialog-actions{ display:flex; justify-content:flex-end; gap:.5rem; margin-top:var(--space-3); }
      .toasts{ position:fixed; right:16px; bottom:16px; z-index:1000; display:grid; gap:8px; width:min(90vw,380px); }
      .toast{ display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:start; background:var(--toast-bg); color:var(--toast-text); border-left:4px solid var(--toast-border-info); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); animation:slideIn .25s ease, fadeOut .3s ease var(--toast-timeout,3.2s) forwards; }
      .toast.success{ border-color:var(--toast-border-success); } .toast.warn{ border-color:var(--toast-border-warn); } .toast.error{ border-color:var(--toast-border-error); }
      .toast .icon{ margin-top:2px; } .toast .title{ font-weight:700; margin-right:auto; } .toast .msg{ opacity:.9; }
      .toast .close{ background:transparent; border:none; color:inherit; cursor:pointer; font-size:18px; line-height:1; }
      .toast .bar{ grid-column:1/-1; height:3px; border-radius:0 0 8px 8px; background:linear-gradient(90deg,currentColor,transparent); opacity:.35; animation:barShrink linear var(--toast-timeout,3.2s) forwards; }
      .toast.success .bar{ color:var(--toast-border-success); } .toast.warn .bar{ color:var(--toast-border-warn); } .toast.error .bar{ color:var(--toast-border-error); }
      @keyframes slideIn{ from{ transform:translateY(10px); opacity:0; } to{ transform:translateY(0); opacity:1; } }
      @keyframes fadeOut{ to{ opacity:0; transform:translateY(6px); height:0; margin:0; padding-top:0; padding-bottom:0; } }
      @keyframes barShrink{ from{ width:100%; } to{ width:0%; } }
    </style>
  </head>

  <body>
    <header class="header">
      <div class="title"><span aria-hidden="true">üåÄ</span><span>Exaustor Monitor</span></div>
      <div class="actions">
        <div id="connDot" class="conn-dot" title="Status da conex√£o"></div>
        <button class="btn btn-icon" id="btnTheme" aria-label="Alternar tema">
          <span class="theme-icon" id="iconSun" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zm10.48 0l1.79-1.79 1.79 1.79-1.79 1.79-1.79-1.79zM12 2h0a1 1 0 011 1v2a1 1 0 11-2 0V3a1 1 0 011-1zm0 17a5 5 0 100-10 5 5 0 000 10zm8 2a1 1 0 100-2h-2a1 1 0 100 2h2zM4 21a1 1 0 100-2H2a1 1 0 100 2h2zm15.24-3.84l1.79 1.79 1.79-1.79-1.79-1.79-1.79 1.79zM4.84 6.63L3.05 4.84 1.26 6.63l1.79 1.79 1.79-1.79zM12 19a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1z"/></svg></span>
          <span class="theme-icon hide" id="iconMoon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg></span>
          <span id="themeLabel">Tema</span>
        </button>
        <button class="btn" id="btnConfig" aria-controls="config" aria-expanded="false">‚öôÔ∏è Config</button>
      </div>
    </header>

    <main>
      <section class="cards" aria-label="Status e alertas">
        <article class="card">
          <h2>Status LED</h2>
          <div class="status-row">
            <div id="led" aria-live="polite">--</div>
            <button class="btn" id="btnToggleLED">Alternar LED</button>
          </div>
          <p class="muted" id="networkInfo"></p>
        </article>

        <article class="card">
          <h2>Alertas</h2>
          <p id="tempAlert" class="alert">--</p>
          <p id="fanAlert" class="alert">--</p>
        </article>
      </section>

      <section class="chart-grid" aria-label="Gr√°ficos">
        <div class="chart-box"><canvas id="tempChart" height="180"></canvas></div>
        <div class="chart-box"><canvas id="humChart"  height="180"></canvas></div>
        <div class="chart-box"><canvas id="fanChart"  height="180"></canvas></div>
      </section>
    </main>

    <!-- Painel de Configura√ß√£o -->
    <aside id="config" class="config-panel" role="dialog" aria-modal="true" aria-labelledby="configTitle" hidden>
      <div class="config-content" role="document">
        <div class="config-header">
          <h2 id="configTitle" style="margin:0;">Configura√ß√µes</h2>
          <button class="btn btn--ghost" id="closeConfig" aria-label="Fechar configura√ß√µes">‚úñ</button>
        </div>

        <nav class="tabs" role="tablist" aria-label="Abas de configura√ß√£o">
          <button class="tab" role="tab" aria-selected="true"  aria-controls="tab-wifi"          id="tabbtn-wifi"          data-tab="wifi">Wi‚ÄëFi</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="tab-notificacoes" id="tabbtn-notificacoes" data-tab="notificacoes">Notifica√ß√µes</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="tab-visual"       id="tabbtn-visual"       data-tab="visual">Exibi√ß√£o</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="tab-fan"          id="tabbtn-fan"          data-tab="fan">Ventila√ß√£o</button>
        </nav>

        <section id="tab-wifi" class="tab-content active" role="tabpanel" aria-labelledby="tabbtn-wifi">
          <fieldset>
            <legend>Configura√ß√£o AP</legend>
            <div class="row">
              <label for="ap_ssid">SSID do AP</label>
              <input id="ap_ssid" type="text" placeholder="EXAUSTOR_AP" maxlength="32" />
              <label for="ap_pass">Senha do AP</label>
              <input id="ap_pass" type="password" placeholder="8‚Äì63 caracteres" minlength="8" maxlength="63" />
            </div>
            <div class="form-actions">
              <button class="btn" id="saveAP">Salvar AP</button>
            </div>
          </fieldset>

          <fieldset>
            <legend>Configura√ß√£o Cliente</legend>
            <div class="row">
              <label for="sta_ssid">SSID Wi‚ÄëFi</label>
              <input id="sta_ssid" type="text" placeholder="Nome da rede" maxlength="32" />
              <label for="sta_pass">Senha Wi‚ÄëFi</label>
              <input id="sta_pass" type="password" placeholder="8‚Äì63 caracteres" minlength="8" maxlength="63" />
              <label for="sta_site">Site (opcional)</label>
              <input id="sta_site" type="text" placeholder="meusite.casa" inputmode="url" />
            </div>
            <div class="form-actions">
              <button class="btn" id="saveSTA">Salvar STA</button>
            </div>
          </fieldset>
        </section>

        <section id="tab-notificacoes" class="tab-content" role="tabpanel" aria-labelledby="tabbtn-notificacoes">
          <fieldset>
            <legend>Temperatura</legend>
            <label><input type="checkbox" id="tempNotif" /> Ativar notifica√ß√£o</label>
            <label for="tempLimite">Temperatura limite (¬∞C)</label>
            <input id="tempLimite" type="number" step="0.5" min="-40" max="125" placeholder="Ex: 60" />
            <label><input type="checkbox" id="tempBip" /> Bip</label>
            <label><input type="checkbox" id="tempLed" /> LED</label>
          </fieldset>

          <fieldset>
            <legend>Exaustor</legend>
            <label><input type="checkbox" id="fanNotif" /> Notificar exaustor parado</label>
            <label><input type="checkbox" id="fanBip" /> Bip</label>
            <label><input type="checkbox" id="fanLed" /> LED</label>
          </fieldset>

          <div class="dialog-actions">
            <button class="btn" id="saveNotif">Salvar Notifica√ß√µes</button>
          </div>
        </section>

        <section id="tab-visual" class="tab-content" role="tabpanel" aria-labelledby="tabbtn-visual">
          <fieldset>
            <legend>Tema</legend>
            <div class="row-3">
              <label><input type="radio" name="theme" value="auto"  id="theme_auto"  /> Sistema</label>
              <label><input type="radio" name="theme" value="light" id="theme_light" /> Claro</label>
              <label><input type="radio" name="theme" value="dark"  id="theme_dark"  /> Escuro</label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Gr√°ficos</legend>
            <div class="row-2">
              <label><input type="checkbox" id="ch_points" /> Mostrar pontos</label>
              <label><input type="checkbox" id="ch_fill" /> Preencher √°rea</label>
              <label><input type="checkbox" id="ch_gridx" checked /> Grade eixo X</label>
              <label><input type="checkbox" id="ch_gridy" checked /> Grade eixo Y</label>
              <label><input type="checkbox" id="ch_legend" checked /> Mostrar legenda</label>
              <label><input type="checkbox" id="ch_decimation" checked /> Decimation</label>
            </div>
            <div class="row-2" style="margin-top:.6rem;">
              <div>
                <label for="rng_tension">Suaviza√ß√£o (0‚Äì0.4)</label>
                <input type="range" id="rng_tension" min="0" max="0.4" step="0.05" />
              </div>
              <div>
                <label for="num_maxPoints">Limite de pontos (10‚Äì120)</label>
                <input type="number" id="num_maxPoints" min="10" max="120" step="5" />
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn--ghost" id="resetVisual">Restaurar padr√£o</button>
              <button class="btn" id="applyVisual">Aplicar</button>
            </div>
          </fieldset>
        </section>

        <section id="tab-fan" class="tab-content" role="tabpanel" aria-labelledby="tabbtn-fan">
          <fieldset>
            <legend>Controle do Cooler</legend>
            <label for="fanDuty">Duty do PWM (%)</label>
            <input id="fanDuty" type="range" min="0" max="100" step="1" />
            <div class="muted">Valor: <b><span id="fanDutyVal">--</span>%</b></div>
          </fieldset>

          <fieldset>
            <legend>Par√¢metros de RPM</legend>
            <div class="row-2">
              <div>
                <label for="fanPulses">Pulsos por volta (1‚Äì12)</label>
                <input id="fanPulses" type="number" min="1" max="12" step="1" />
              </div>
              <div>
                <label for="rpmAlertMin">RPM m√≠nimo p/ alerta</label>
                <input id="rpmAlertMin" type="number" min="0" max="20000" step="10" />
              </div>
            </div>
            <div class="form-actions">
              <button class="btn" id="saveFanCfg">Salvar par√¢metros</button>
            </div>
          </fieldset>
        </section>

        <div class="dialog-actions">
          <button class="btn btn--ghost" id="closeConfig2">Fechar</button>
        </div>
      </div>
    </aside>

    <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

    <script>
      (() => {
        // === Helpers / Toasts / Tema ===
        const $  = (s, r=document) => r.querySelector(s);
        const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
        const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
        const toastsEl = $('#toasts');
        const icons = {
          info:'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20A10 10 0 0012 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>',
          success:'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm-1 14l-4-4 1.41-1.41L11 12.17l4.59-4.58L17 9l-6 7z"/></svg>',
          warn:'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
          error:'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm4.3 13.89L13.89 16.3 12 14.41 10.11 16.3 7.7 13.89 9.59 12 7.7 10.11 10.11 7.7 12 9.59l1.89-1.89 2.41 2.41L14.41 12l1.89 1.89z"/></svg>'
        };
        function toast(message, type='info', title='', { timeout=3200, persist=false }={}) {
          const el = document.createElement('div');
          el.className = `toast ${type}`;
          el.style.setProperty('--toast-timeout', persist ? '9999s' : `${timeout/1000}s`);
          el.innerHTML = `<div class="icon" aria-hidden="true">${icons[type]||icons.info}</div>
            <div><div class="title">${title || (type==='success'?'Sucesso':type==='error'?'Erro':type==='warn'?'Aten√ß√£o':'Info')}</div><div class="msg">${message}</div></div>
            <button class="close" aria-label="Fechar">√ó</button><div class="bar"></div>`;
          const remove = () => el.parentNode && el.parentNode.removeChild(el);
          el.querySelector('.close').addEventListener('click', remove);
          toastsEl.appendChild(el);
          if (!persist) setTimeout(remove, timeout + 400);
        }

        const THEME_KEY='ui_theme';
        const themeRadios=$$('input[name="theme"]'); const btnTheme=$('#btnTheme'), iconSun=$('#iconSun'), iconMoon=$('#iconMoon'), themeLabel=$('#themeLabel');
        const mql=matchMedia('(prefers-color-scheme: dark)');
        const readTheme=()=>{ try{ return localStorage.getItem(THEME_KEY)||'auto'; }catch{ return 'auto'; } };
        const writeTheme=v=>{ try{ localStorage.setItem(THEME_KEY, v); }catch{} };
        function applyTheme(choice){ let eff=choice==='auto'?(mql.matches?'dark':'light'):choice; document.documentElement.setAttribute('data-theme',eff);
          if(eff==='dark'){ iconSun.classList.add('hide'); iconMoon.classList.remove('hide'); themeLabel.textContent='Escuro'; }
          else { iconMoon.classList.add('hide'); iconSun.classList.remove('hide'); themeLabel.textContent='Claro'; }
          themeRadios.forEach(r=>r.checked=(r.value===choice)); writeTheme(choice);
          const meta=document.querySelector('meta[name="theme-color"]'); if(meta) meta.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--bg').trim());
        }
        function loadTheme(){ applyTheme(readTheme()); }
        mql.addEventListener('change', ()=>{ if(readTheme()==='auto') applyTheme('auto'); });
        btnTheme.addEventListener('click', ()=>{ const c=readTheme(); const cur=document.documentElement.getAttribute('data-theme'); const next=c==='auto'?'dark':(cur==='dark'?'light':'dark'); applyTheme(next); toast(`Tema aplicado: ${next==='light'?'Claro':'Escuro'}`,'success','Tema',{timeout:1800}); });
        themeRadios.forEach(r=>r.addEventListener('change',()=>applyTheme(r.value)));

        // === WebSocket com reconex√£o/heartbeat/ACKs ===
        const connDot=$('#connDot'); const setConn=s=>{ connDot.classList.remove('is-ok','is-warn','is-bad'); connDot.classList.add(s==='ok'?'is-ok':s==='warn'?'is-warn':'is-bad'); };
        let ws=null, retries=0, hbTimer=null; const MAX_RETRY_DELAY=10000, HEARTBEAT_MS=15000; const sendQueue=[];
        const pendingById=new Map(), pendingByOf=new Map();
        const wsUrl = () => (location.protocol==='https:'?'wss':'ws') + '://' + location.hostname + ':81/';
        function connectWS(){
          try{ ws = new WebSocket(wsUrl()); }catch(e){ return scheduleReconnect(); }
          ws.onopen = ()=>{ setConn('ok'); const wasRetry=retries>0; retries=0; toast('Conectado ao dispositivo.','success','Conex√£o',{timeout:1600});
            while(sendQueue.length) ws.send(sendQueue.shift()); startHeartbeat(); if(wasRetry) safeSend({type:'state'}); };
          ws.onmessage = (evt)=>{ let data; try{ data=JSON.parse(evt.data);}catch{return;}
            if(data?.type==='ack' || data?.type==='error'){ handleAck(data); return; }
            if(data?.type==='pong') return;
            updateFromState(data);
          };
          ws.onclose = ()=>{ setConn('bad'); stopHeartbeat(); toast('Conex√£o perdida. Tentando reconectar‚Ä¶','warn','Conex√£o',{timeout:2400}); scheduleReconnect(); };
        }
        function scheduleReconnect(){ const d=Math.min(1000*Math.pow(2,retries)+Math.random()*500,MAX_RETRY_DELAY); retries++; setConn('bad'); setTimeout(connectWS,d); }
        function startHeartbeat(){ stopHeartbeat(); hbTimer=setInterval(()=>safeSend({type:'ping',t:Date.now()}), HEARTBEAT_MS); }
        function stopHeartbeat(){ if(hbTimer) clearInterval(hbTimer); hbTimer=null; }
        function safeSend(obj){ const p=JSON.stringify(obj); if(ws&&ws.readyState===WebSocket.OPEN) try{ws.send(p);}catch{sendQueue.push(p);} else sendQueue.push(p); }
        const genMsgId=()=> Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8);
        function prepareAck(obj,{expectAckOf,timeoutMs=8000}){ const msgId=genMsgId(); obj.msgId=msgId; let resolve, reject; const done=new Promise((res,rej)=>{resolve=res; reject=rej;});
          const t=setTimeout(()=>{ pendingById.delete(msgId); if(expectAckOf) pendingByOf.delete(expectAckOf); reject(new Error('ACK timeout')); toast(`Sem resposta para ${expectAckOf}.`,'error','Timeout'); }, timeoutMs);
          pendingById.set(msgId,{resolve,reject,timeout:t}); if(expectAckOf) pendingByOf.set(expectAckOf,{resolve,reject,timeout:t}); return done; }
        function handleAck(ack){ const {msgId,of,ok,message}=ack; let entry=null;
          if(msgId && pendingById.has(msgId)){ entry=pendingById.get(msgId); pendingById.delete(msgId); if(of&&pendingByOf.has(of)) pendingByOf.delete(of); }
          else if(of && pendingByOf.has(of)){ entry=pendingByOf.get(of); pendingByOf.delete(of); }
          if(entry){ clearTimeout(entry.timeout); ok?entry.resolve(ack):entry.reject(new Error(message||'ACK com falha')); }
          toast(message || (ok?`Configura√ß√£o ${of} aplicada.`:`Falha ao aplicar ${of}.`), ok?'success':'error', 'ACK', { timeout:1600 });
        }

        // === Charts (temperatura, umidade, RPM) ===
        const labels=[], tempData=[], humData=[], fanData=[];
        function makeLineChart(ctx,label,color,yMax){ return new Chart(ctx,{type:'line', data:{labels, datasets:[{label, data: label==='Umidade (%)'?humData : label==='Temperatura (¬∞C)'?tempData:fanData, borderColor:color, backgroundColor:color+'33', fill:false, pointRadius:0, tension:.25}]},
          options:{responsive:true, maintainAspectRatio:false, animation:false, normalized:true, parsing:false, spanGaps:true,
            scales:{ x:{ticks:{color:'#dcdcdc'}, grid:{color:'rgba(255,255,255,.07)'}}, y:{beginAtZero:true, max:yMax, ticks:{color:'#dcdcdc'}, grid:{color:'rgba(255,255,255,.07)'}} },
            plugins:{ legend:{labels:{color:'#fff'}}, tooltip:{mode:'index',intersect:false}, decimation:{enabled:true,algorithm:'min-max'} } }); }
        const tempChart=makeLineChart($('#tempChart').getContext('2d'),'Temperatura (¬∞C)','#ff9800');
        const humChart =makeLineChart($('#humChart').getContext('2d'), 'Umidade (%)','#03a9f4',100);
        const fanChart =makeLineChart($('#fanChart').getContext('2d'), 'Velocidade (RPM)','#8bc34a');

        let updateScheduled=false; function scheduleChartsUpdate(){ if(updateScheduled) return; updateScheduled=true; requestAnimationFrame(()=>{ tempChart.update('none'); humChart.update('none'); fanChart.update('none'); updateScheduled=false; }); }

        const PREFS_KEY='ui_prefs'; const defaultPrefs={charts:{showPoints:false, fill:false, tension:.25, gridX:true, gridY:true, legend:true, decimation:true, maxPoints:30}};
        let prefs=loadPrefs(); function loadPrefs(){ try{ const raw=localStorage.getItem(PREFS_KEY); return raw? Object.assign(structuredClone(defaultPrefs), JSON.parse(raw)) : structuredClone(defaultPrefs);}catch{ return structuredClone(defaultPrefs);} }
        function savePrefs(){ try{ localStorage.setItem(PREFS_KEY, JSON.stringify(prefs)); }catch{} }
        function applyChartPrefs(){ [tempChart,humChart,fanChart].forEach(ch=>{ const ds=ch.data.datasets[0]; ds.pointRadius=prefs.charts.showPoints?2:0; ds.fill=!!prefs.charts.fill; ds.tension=clamp(prefs.charts.tension,0,0.4); ch.options.scales.x.grid.display=!!prefs.charts.gridX; ch.options.scales.y.grid.display=!!prefs.charts.gridY; ch.options.plugins.legend.display=!!prefs.charts.legend; ch.options.plugins.decimation.enabled=!!prefs.charts.decimation; ch.update('none'); }); }
        function pushDataPoint(s){ const now=new Date().toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
          let add=false; if(typeof s.temp==='number' && !Number.isNaN(s.temp)){ tempData.push(s.temp); add=true; } if(typeof s.hum==='number' && !Number.isNaN(s.hum)){ humData.push(clamp(s.hum,0,100)); add=true; }
          let rpm= typeof s.fanRpm==='number'?Math.max(0,Math.round(s.fanRpm)):undefined; if(typeof rpm==='number'){ fanData.push(rpm); add=true; }
          if(add){ labels.push(now); const MP=clamp(prefs.charts.maxPoints,10,120); while(labels.length>MP){ labels.shift(); if(tempData.length>MP) tempData.shift(); if(humData.length>MP) humData.shift(); if(fanData.length>MP) fanData.shift(); } scheduleChartsUpdate(); }
        }

        // === UI de estado ===
        const elLed=$('#led'), elTempAlert=$('#tempAlert'), elFanAlert=$('#fanAlert'), elNetworkInfo=$('#networkInfo');
        const elFanDuty=$('#fanDuty'), elFanDutyVal=$('#fanDutyVal'), elFanPulses=$('#fanPulses'), elRpmAlertMin=$('#rpmAlertMin');

        function updateFromState(d){
          if (elLed) elLed.textContent = (d.led===true||d.led==='on')?'LED: LIGADO':(d.led===false||d.led==='off')?'LED: DESLIGADO':(typeof d.led==='string'?d.led:'--');
          if (elTempAlert){ const t=d.tempAlert; elTempAlert.textContent = t===true||t==='high' ? '‚ö†Ô∏è Temperatura alta!' : (typeof t==='string'&&t.trim()?t:'--'); }
          if (elFanAlert){ const f=d.fanAlert; elFanAlert.textContent  = f===true||f==='stopped' ? '‚ö†Ô∏è Exaustor parado!' : (typeof f==='string'&&f.trim()?f:'--'); }
          if (elNetworkInfo){ const ssid=d.staSsid||d.ssid, ip=d.ip||d.staIp||''; elNetworkInfo.textContent = ssid?`Conectado a: ${ssid} ‚Ä¢ IP: ${ip||'-'}`:''; }

          // Atualiza controles da aba Ventila√ß√£o
          if (typeof d.fanDuty==='number'){ elFanDuty.value = clamp(d.fanDuty,0,100); elFanDutyVal.textContent = elFanDuty.value; }
          if (typeof d.pulsesPerRev==='number'){ elFanPulses.value = clamp(d.pulsesPerRev,1,12); }
          if (typeof d.rpmAlertMin==='number'){ elRpmAlertMin.value = clamp(d.rpmAlertMin,0,20000); }

          pushDataPoint(d);
        }

        // === Modal / Tabs ===
        const configPanel=$('#config'), btnOpenConfig=$('#btnConfig'), btnCloseConfig=$('#closeConfig'), btnCloseConfig2=$('#closeConfig2');
        let lastFocused=null;
        function openConfig(){ lastFocused=document.activeElement; configPanel.hidden=false; btnOpenConfig.setAttribute('aria-expanded','true'); configPanel.querySelector('button, input, [tabindex]:not([tabindex="-1"])')?.focus(); trapFocus(configPanel); }
        function closeConfig(){ configPanel.hidden=true; btnOpenConfig.setAttribute('aria-expanded','false'); releaseFocusTrap(); lastFocused?.focus(); }
        btnOpenConfig.addEventListener('click', openConfig); btnCloseConfig.addEventListener('click', closeConfig); btnCloseConfig2?.addEventListener('click', closeConfig);
        configPanel.addEventListener('click', e=>{ if(e.target===configPanel) closeConfig(); });
        document.addEventListener('keydown', e=>{ if(!configPanel.hidden && e.key==='Escape') closeConfig(); });
        let focusTrapHandler=null; function trapFocus(container){ focusTrapHandler=(e)=>{ if(e.key!=='Tab') return; const f=Array.from(container.querySelectorAll('.config-content button, .config-content [href], .config-content input, .config-content select, .config-content textarea, .config-content [tabindex]:not([tabindex="-1"])')).filter(el=>!el.hasAttribute('disabled')); if(!f.length) return; const first=f[0], last=f[f.length-1]; if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); } else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } }; document.addEventListener('keydown', focusTrapHandler); }
        function releaseFocusTrap(){ if(focusTrapHandler) document.removeEventListener('keydown', focusTrapHandler); focusTrapHandler=null; }

        const tabButtons=$$('.tab[role="tab"]'); const tabPanels=$$('.tab-content[role="tabpanel"]');
        function showTab(name){ tabButtons.forEach(b=>b.setAttribute('aria-selected', String(b.dataset.tab===name))); tabPanels.forEach(p=>{ const a=p.id==='tab-'+name; p.classList.toggle('active',a); p.hidden=!a; }); }
        tabButtons.forEach(b=>b.addEventListener('click', ()=>showTab(b.dataset.tab))); showTab('wifi');

        // === Bot√µes principais (LED / AP / STA / Notif) ===
        $('#btnToggleLED').addEventListener('click', async ()=>{
          const cmd={type:'led'}; const ack=prepareAck(cmd,{expectAckOf:'led'}); safeSend(cmd); try{ await ack; }catch{}
        });
        function validPass(p){ return !p || (p.length>=8 && p.length<=63); }
        $('#saveAP').addEventListener('click', async ()=>{
          const ssid=$('#ap_ssid').value.trim(), pass=$('#ap_pass').value.trim();
          if(!ssid) return toast('Informe o SSID do AP.','warn','AP');
          if(!validPass(pass)) return toast('Senha do AP deve ter entre 8 e 63 caracteres.','warn','AP');
          const cmd={type:'ap',ssid,pass}; const ack=prepareAck(cmd,{expectAckOf:'ap'}); safeSend(cmd); try{ await ack; }catch{}
        });
        $('#saveSTA').addEventListener('click', async ()=>{
          const ssid=$('#sta_ssid').value.trim(), pass=$('#sta_pass').value.trim(), site=$('#sta_site').value.trim();
          if(!ssid) return toast('Informe o SSID Wi‚ÄëFi.','warn','STA');
          if(!validPass(pass)) return toast('Senha do Wi‚ÄëFi deve ter entre 8 e 63 caracteres.','warn','STA');
          const cmd={type:'sta',ssid,pass,site}; const ack=prepareAck(cmd,{expectAckOf:'sta'}); safeSend(cmd); try{ await ack; }catch{}
        });
        $('#saveNotif').addEventListener('click', async ()=>{
          const payload={ type:'notif',
            tempNotif:$('#tempNotif').checked, tempLimite:Number($('#tempLimite').value)||null, tempBip:$('#tempBip').checked, tempLed:$('#tempLed').checked,
            fanNotif:$('#fanNotif').checked, fanBip:$('#fanBip').checked, fanLed:$('#fanLed').checked };
          const cmd={...payload}; const ack=prepareAck(cmd,{expectAckOf:'notif'}); safeSend(cmd); try{ await ack; }catch{}
        });

        // === Ventila√ß√£o: Duty (fanPwm) + Par√¢metros (fanCfg) ===
        const elFanDuty=$('#fanDuty'), elFanDutyVal=$('#fanDutyVal'), elFanPulses=$('#fanPulses'), elRpmAlertMin=$('#rpmAlertMin');

        elFanDuty.addEventListener('input', ()=>{ elFanDutyVal.textContent = elFanDuty.value; });
        elFanDuty.addEventListener('change', async ()=>{
          const duty = clamp(parseInt(elFanDuty.value||'0',10), 0, 100);
          const cmd = { type:'fanPwm', duty };
          const ack = prepareAck(cmd, { expectAckOf:'fanPwm' });
          safeSend(cmd); try{ await ack; }catch{}
        });

        $('#saveFanCfg').addEventListener('click', async ()=>{
          const pulses = clamp(parseInt(elFanPulses.value||'2',10), 1, 12);
          const rmin   = clamp(parseInt(elRpmAlertMin.value||'100',10), 0, 20000);
          const cmd = { type:'fanCfg', pulsesPerRev: pulses, rpmAlertMin: rmin };
          const ack = prepareAck(cmd, { expectAckOf:'fanCfg' });
          safeSend(cmd); try{ await ack; }catch{}
        });

        // === Inicializa√ß√£o ===
        loadTheme(); applyChartPrefs(); connectWS();
      })();
    </script>
  </body>
</html>
