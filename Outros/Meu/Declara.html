<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Declara√ß√£o de Embarque</title>
    <style>
      :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-800: #1e293b;
        --error: #ef4444;
        --success: #22c55e;
      }
      body {
        font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
        padding: 24px;
        max-width: 900px;
        margin: auto;
        color: var(--gray-800);
        background: var(--gray-50);
        line-height: 1.5;
      }
      label {
        display: block;
        margin-top: 12px;
        font-weight: 500;
        color: var(--gray-700);
        font-size: 0.875rem;
      }
      input, textarea {
        width: auto;
        padding: 0.625rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        margin-top: 4px;
        font-size: 0.875rem;
        transition: all 0.2s;
        background: white;
      }
      select {
        width: 50%;
        padding: 0.625rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        margin-top: 4px;
        font-size: 0.875rem;
        transition: all 0.2s;
        background: white;
      }
      input:hover, textarea:hover, select:hover {
        border-color: var(--gray-600);
      }
      input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
      }
      .row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
      }
      .row > * {
        flex: 1;
      }
      .actions {
        margin-top: 24px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      button {
        padding: 0.625rem 1rem;
        border-radius: 0.5rem;
        border: 0;
        background: var(--primary);
        color: white;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      button:hover {
        background: var(--primary-hover);
      }
      button.ghost {
            width: max-content;
        background: white;
        color: var(--gray-700);
        border: 1px solid var(--gray-300);
      }
      button.ghost:hover {
        background: var(--gray-100);
        border-color: var(--gray-600);
      }
      button.danger {
        background: var(--error);
        color: white;
      }
      button.danger:hover {
        background: #dc2626;
      }
      pre#preview {
        white-space: pre-wrap;
        background: white;
        border: 1px solid var(--gray-200);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1.5rem;
        font-size: 0.875rem;
        line-height: 1.6;
        color: var(--gray-700);
      }
      .muted {
        color: var(--gray-600);
        font-size: 0.875rem;
      }
      fieldset.conexao-bloco {
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1rem 0;
      }
      fieldset.conexao-bloco legend {
        padding: 0 0.5rem;
        font-weight: 500;
        color: var(--gray-700);
      }
      h1, h3 {
        color: var(--gray-800);
        margin-bottom: 1rem;
      }
      h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }
      h3 {
        font-size: 1.25rem;
        font-weight: 500;
        margin-top: 2rem;
      }
      /* Aero-select autocomplete styles */
      .aero-search-wrapper {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        position: relative;
      }
      .aero-search-input {
        padding: 0.5rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        font-size: 0.85rem;
        min-width: 160px;
        max-width: 45%;
        background: white;
      }
      .aero-suggestions {
        position: absolute;
        z-index: 1200;
        left: 0;
        right: 0;
        top: calc(100% + 6px);
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 6px;
        box-shadow: 0 6px 18px rgba(15,23,42,0.08);
        max-height: 220px;
        overflow: auto;
        display: none;
      }
      .aero-suggestion-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        font-size: 0.875rem;
      }
      .aero-suggestion-item:hover {
        background: var(--gray-100);
      }
    </style>
  </head>
  <body>
    <h1>Declara√ß√£o de Embarque</h1>
    <p class="muted">
      Preencha os campos abaixo e clique em "Gerar Declara√ß√£o" para criar o
      texto formatado.
    </p>
    <div class="row">
      <label for="cidade">Cidade da declara√ß√£o</label>
      <input id="cidade" value="S√£o Paulo" readonly />
      <label for="declaracao_date">Data da declara√ß√£o</label>
      <input
        id="declaracao_date"
        type="date"
        aria-label="data da declaracao"
        readonly
      />

      <label for="companhia">Companhia a√©rea</label>
      <input id="companhia" value="GOL Linhas A√©reas S.A" readonly disabled />
    </div>
    <div class="row">
      <input id="OouA" placeholder="O ou A" />
      <label for="nome">Nome do(a) passageiro(a)</label>
      <input id="nome" placeholder="nome" />

      <label for="localizador">C√≥digo localizador</label>
      <input id="localizador" placeholder="ABCDEF" />
    </div>

    <h3>Voo de ida</h3>
    <label>Tipo de viagem</label>
    <select
      id="tipo_viagem_select"
      onchange="marcadoida()"
      style="
    width: auto;
"
    >
      <option placeholder="tipo"></option>
      <option value="ida">IDA</option>
      <option value="ida/volta">IDA/VOLTA</option>
    </select>
    <div id="CaixaDida" style="display: none;">
      <div class="row">
        <div>
          <label for="ida_data">Data (ida)</label>
          <input id="ida_data" type="date" aria-label="data ida" required />
        </div>
        <div>
          <label for="ida_num">N√∫mero do voo</label>
          <input id="ida_num" placeholder="1234" />
        </div>
      </div>
      <div>
      <label for="ida_conexoes_count">N√∫mero de conex√µes (ida)</label>
      <input id="ida_conexoes_count" type="number" min="0" value="0" />
      </div>
      <div class="row">
        <div>
          <label for="ida_partida_aero">Partida</label>
          <select id="ida_partida_aero" class="aero-select">
            <option></option>
          </select>
        </div>
        <div>
          <label for="ida_partida_hora">Hor√°rio partida</label>
          <input id="ida_partida_hora" placeholder="23:59" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="ida_chegada_aero">Chegada</label>
          <select id="ida_chegada_aero" class="aero-select">
            <option></option>
          </select>
        </div>
        <div>
          <label for="ida_chegada_hora">Hor√°rio chegada</label>
          <input id="ida_chegada_hora" placeholder="23:59" />
        </div>
      </div>
      
      <div id="ida_conexoes_container"></div>
    </div>

    <h3>Voo de volta</h3>
    <div id="CaixaDvolta" style=" display: none;">
      <div class="row">
        <div>
          <label for="volta_data">Data (volta)</label>
          <input id="volta_data" type="date" aria-label="data volta" required />
        </div>
        <div>
          <label for="volta_num">N√∫mero do voo</label>
          <input id="volta_num" placeholder="1234" />
        </div>
      </div>
      <div>
        <label for="volta_conexoes_count">N√∫mero de conex√µes (volta)</label>
        <input id="volta_conexoes_count" type="number" min="0" value="0" />
      </div>
      <div class="row">
        <div>
          <label for="volta_partida_aero">Partida</label>
          <select id="volta_partida_aero" class="aero-select">
            <option></option>
          </select>
        </div>
        <div>
          <label for="volta_partida_hora">Hor√°rio partida</label>
          <input id="volta_partida_hora" placeholder="23:59" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="volta_chegada_aero">Chegada</label>
          <select id="volta_chegada_aero" class="aero-select">
            <option></option>
          </select>
        </div>
        <div>
          <label for="volta_chegada_hora">Hor√°rio chegada</label>
          <input id="volta_chegada_hora" placeholder="23:59" />
        </div>
      </div>

      <div id="volta_conexoes_container"></div>
    </div>

    <div class="actions">
      <button id="btn_limpar" class="ghost danger" type="button">
        ‚ü≤ Limpar Formul√°rio
      </button>
      <button id="btn_exemplo" class="ghost" type="button">
        ‚≠ê Carregar Exemplo
      </button>

      <button id="btn_gerar" type="button">üìÑ Gerar Declara√ß√£o</button>
      <button id="btn_copiar" class="ghost" type="button">üìã Copiar</button>
      <button id="btn_imprimir" class="ghost" type="button">üñ®Ô∏è Imprimir</button>
      <button id="btn_baixar" class="ghost" type="button">
        üíæ Baixar .txt
      </button>
    </div>

    <pre id="preview" aria-live="polite"></pre>

    <script>
      const Byid = (id) => document.getElementById(id);

      // ---- Campos de contagem e containers de conex√µes ----
      const ida_conexoes_count = Byid("ida_conexoes_count");
      const ida_conexoes_container = Byid("ida_conexoes_container");

      const volta_conexoes_count = Byid("volta_conexoes_count");
      const volta_conexoes_container = Byid("volta_conexoes_container");

      // ---- Mostrar/ocultar se √© ida e/ou volta ----
      function marcadoida() {
        const CaixaDida = Byid("CaixaDida");
        const CaixaDvolta = Byid("CaixaDvolta");
        const tipo_viagem_select = Byid("tipo_viagem_select");

        if (
          tipo_viagem_select.value === "ida/volta" ||
          tipo_viagem_select.value === "ida"
        ) {
          CaixaDida.style.display = "block";
        } else {
          CaixaDida.style.display = "none";
        }

        if (tipo_viagem_select.value === "ida/volta") {
          CaixaDvolta.style.display = "block";
        } else {
          CaixaDvolta.style.display = "none";
        }
      }

      // ---- Fun√ß√µes de gera√ß√£o de inputs de conex√£o ----
      function inputConexao(trecho, idx) {
        // trecho: "ida" ou "volta"
        return `
      <fieldset class="conexao-bloco">
        <legend>Conex√£o ${idx + 1} (${trecho})</legend>
        <div class="row">
          <div>
            <label for="${trecho}_num_${idx}">N√∫mero do voo</label>
            <input id="${trecho}_num_${idx}" placeholder="1234" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="${trecho}_partida_aero_${idx}">Partida</label>
              <select id="${trecho}_partida_aero_${idx}" class="aero-select"><option></option></select>
          </div>
          <div>
            <label for="${trecho}_partida_hora_${idx}">Hor√°rio partida</label>
              <input id="${trecho}_partida_hora_${idx}" class="time-input" placeholder="2359 or 23:59" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="${trecho}_chegada_aero_${idx}">Chegada</label>
              <select id="${trecho}_chegada_aero_${idx}" class="aero-select"><option></option></select>
          </div>
          <div>
            <label for="${trecho}_chegada_hora_${idx}">Hor√°rio chegada</label>
              <input id="${trecho}_chegada_hora_${idx}" class="time-input" placeholder="2359 or 23:59" />
          </div>
        </div>
      </fieldset>
    `;
      }

      function renderConexoes(trecho, count) {
        const container =
          trecho === "ida" ? ida_conexoes_container : volta_conexoes_container;
        let html = "";
        for (let i = 0; i < count; i++) {
          html += inputConexao(trecho, i);
        }
        if (container) container.innerHTML = html;
        // after injecting connection HTML, populate any new aero-selects
        try {
          buildAirportOptions();
        } catch (e) {
          // ignore if buildAirportOptions not defined yet
        }
      }

      // ---- Eventos para quantidade de conex√µes (IDA/ VOLTA) ----
      if (ida_conexoes_count) {
        ida_conexoes_count.addEventListener("input", () => {
          const qtd = Math.max(0, Number(ida_conexoes_count.value || 0));
          renderConexoes("ida", qtd);
        });
      }

      if (volta_conexoes_count) {
        volta_conexoes_count.addEventListener("input", () => {
          const qtd = Math.max(0, Number(volta_conexoes_count.value || 0));
          renderConexoes("volta", qtd);
        });
      }

      // ---- Preenchimento autom√°tico do aeroporto (IDA e VOLTA) ----
      const ida_partida_aero = Byid("ida_partida_aero");
      const ida_chegada_aero = Byid("ida_chegada_aero");
      const volta_partida_aero = Byid("volta_partida_aero");
      const volta_chegada_aero = Byid("volta_chegada_aero");

      // ---- Texto inicial (cidade e data da declara√ß√£o) ----
      // fun√ß√£o consolidada definida mais adiante (evita duplicatas)

      // ---- Bot√£o "Gerar Declara√ß√£o" ----
      // ===== Fun√ß√µes de a√ß√µes: gerar, copiar, imprimir, baixar, exemplo =====
      function gerarDeclaracao() {
        const preview = Byid("preview");
        const errs = validateRules();
        if (errs.length) {
          preview.innerHTML = `<strong>Corrija os seguintes itens:</strong><br>- ${errs.join(
            "<br>- "
          )}`;
          return null;
        }
        const tipo = Byid("tipo_viagem_select")?.value;
        const partes = [textoInicial(), textodaida()];
        if (tipo === "ida/volta") partes.push(textodavolta());
        const texto = partes.filter(Boolean).join(". ") + ".";
        preview.textContent = texto;
        return texto;
      }

      async function copiarPreview() {
        const preview = Byid("preview");
        const text = preview.textContent || preview.innerText || "";
        if (!text) return false;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (err) {
            // fallback
          }
        }
        // fallback: criar textarea
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand("copy");
          document.body.removeChild(ta);
          return true;
        } catch (e) {
          document.body.removeChild(ta);
          return false;
        }
      }

      function imprimirPreview() {
        // abre nova janela com conte√∫do do preview e chama print
        const txt = Byid("preview").textContent || "";
        const w = window.open("", "_blank");
        if (!w) return false;
        w.document.write(
          `<pre style="font-family:system-ui, -apple-system, Segoe UI, Roboto; white-space:pre-wrap;">${escapeHtml(
            txt
          )}</pre>`
        );
        w.document.close();
        w.focus();
        w.print();
        return true;
      }

      function baixarTxt() {
        const texto = Byid("preview").textContent || gerarDeclaracao() || "";
        if (!texto) return false;
        const nome = (
          Byid("localizador")?.value ||
          Byid("nome")?.value ||
          "declaracao"
        ).replace(/[^a-z0-9\-_]/gi, "_");
        const blob = new Blob([texto], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${nome}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        return true;
      }

      // helper: seleciona uma option de <select> tentando match exato, contains ou por c√≥digo (GRU)
      function setSelectByLabel(selectEl, label) {
            if (!selectEl || !label) return;
            const opts = Array.from(selectEl.options || []);

            // helper: normalize (remove accents, punctuation, lower)
            function normalize(s) {
              return (
                (s || "")
                  .toString()
                  .normalize("NFD")
                  .replace(/[\u0300-\u036f]/g, "")
                  .replace(/[\-‚Äì‚Äî\/\\()\.\,\*]/g, " ")
                  .replace(/\s+/g, " ")
                  .trim()
                  .toLowerCase()
              );
            }

            const lbl = label.toString().trim();
            // exact match (value or text)
            for (const opt of opts) {
              if (opt.value === lbl || opt.textContent === lbl) {
                selectEl.value = opt.value;
                try { selectEl.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
                return;
              }
            }

            const nlbl = normalize(lbl);
            // contains or normalized match
            for (const opt of opts) {
              const tv = (opt.textContent || "").toString();
              if (tv === lbl) {
                selectEl.value = opt.value;
                return;
              }
              if (normalize(tv).includes(nlbl) || normalize(opt.value || "").includes(nlbl)) {
                selectEl.value = opt.value;
                try { selectEl.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
                return;
              }
            }

            // try match by code in parentheses e.g. (GRU) or standalone
            const m = lbl.match(/\(([A-Z0-9]{2,4})\)/i) || lbl.match(/\b([A-Z]{2,4})\b/);
            if (m) {
              const code = (m[1] || "").toUpperCase();
              for (const opt of opts) {
                const tv = opt.textContent || opt.value || "";
                if (tv.includes(`(${code})`) || tv.includes(code)) {
                  selectEl.value = opt.value;
                  try { selectEl.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
                  return;
                }
              }
            }

            // last resort: try partial word matches (e.g., 'guarulhos' or 'recife')
            const tokens = nlbl.split(" ").filter(Boolean);
            if (tokens.length) {
              for (const opt of opts) {
                const nt = normalize(opt.textContent || opt.value || "");
                let matches = 0;
                for (const t of tokens) if (nt.includes(t)) matches++;
                // choose option that matches at least half of the tokens
                if (matches >= Math.max(1, Math.floor(tokens.length / 2))) {
                  selectEl.value = opt.value;
                  try { selectEl.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
                  return;
                }
              }
            }

            // fallback: set raw value
            try {
              selectEl.value = label;
              try { selectEl.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
            } catch (e) {
              // ignore
            }
      }

      // attach small helpers to allow users to search airports via an input
      // and see a popup of suggestions while typing
      function attachAeroSelectHandlers() {
        const list = parseRawAirports(rawAeroportos || "");
        const nodes = Array.from(document.querySelectorAll("select.aero-select"));
        for (const el of nodes) {
          // avoid attaching multiple times
          if (el.dataset.aeroHandler) continue;

          // create wrapper and search input + suggestions container
          const wrapper = document.createElement("div");
          wrapper.className = "aero-search-wrapper";
          el.parentNode.insertBefore(wrapper, el);
          wrapper.appendChild(el);

          const input = document.createElement("input");
          input.type = "text";
          input.className = "aero-search-input";
          input.placeholder = "Buscar aeroporto (c√≥digo/nome)";
          wrapper.appendChild(input);

          const sug = document.createElement("div");
          sug.className = "aero-suggestions";
          wrapper.appendChild(sug);

          // sync input when select changes
          function syncInputFromSelect() {
            input.value = (el.selectedOptions && el.selectedOptions[0] && el.selectedOptions[0].textContent) || el.value || "";
          }
          syncInputFromSelect();
          el.addEventListener("change", syncInputFromSelect);
          // hide the native select and let the input be the visible control
          try { el.style.display = "none"; } catch (e) {}

          // helper normalize
          const normalize = (s) =>
            (s || "")
              .toString()
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "")
              .replace(/[\-‚Äì‚Äî\/\\()\.\,\*]/g, " ")
              .replace(/\s+/g, " ")
              .trim()
              .toLowerCase();

          let currentMatches = [];

          input.addEventListener("input", () => {
            const q = input.value.trim();
            if (!q) {
              sug.innerHTML = "";
              sug.style.display = "none";
              return;
            }
            const qn = normalize(q);
            const matches = list
              .filter((it) => normalize(it.label).includes(qn) || (it.code || "").toLowerCase().includes(qn))
              .slice(0, 10);
            currentMatches = matches;
            sug.innerHTML = "";
            for (const m of matches) {
              const it = document.createElement("div");
              it.className = "aero-suggestion-item";
              it.textContent = m.label;
              it.addEventListener("mousedown", (ev) => {
                // use mousedown to prevent losing focus before click
                ev.preventDefault();
                setSelectByLabel(el, m.label);
                syncInputFromSelect();
                sug.innerHTML = "";
                sug.style.display = "none";
                input.focus();
              });
              sug.appendChild(it);
            }
            sug.style.display = matches.length ? "block" : "none";
          });

          // enter picks the first suggestion
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              if (currentMatches && currentMatches[0]) {
                setSelectByLabel(el, currentMatches[0].label);
                syncInputFromSelect();
                sug.innerHTML = "";
                sug.style.display = "none";
              }
            }
            if (e.key === "Escape") {
              sug.innerHTML = "";
              sug.style.display = "none";
            }
          });

          // hide suggestions when clicking outside
          document.addEventListener("click", (ev) => {
            if (!wrapper.contains(ev.target)) {
              sug.innerHTML = "";
              sug.style.display = "none";
            }
          });

          // mark as attached
          el.dataset.aeroHandler = "1";
        }
      }

      function carregarExemplo() {
        // valores de exemplo
        Byid("OouA").value = "o";
        Byid("nome").value = "Jo√£o da Silva";
        Byid("localizador").value = "ABC123";
        Byid("tipo_viagem_select").value = "ida/volta";
        marcadoida();
        // conex√µes zero
        Byid("ida_conexoes_count").value = "0";
        renderConexoes("ida", 0);
        Byid("volta_conexoes_count").value = "0";
        renderConexoes("volta", 0);
  // ida
        Byid("ida_data").value = new Date().toISOString().split("T")[0];
        Byid("ida_num").value = "1234";
  setSelectByLabel(Byid("ida_partida_aero"), "S√£o Paulo - Guarulhos (GRU)");
        Byid("ida_partida_hora").value = "10:50";
  setSelectByLabel(Byid("ida_chegada_aero"), "Recife (REC)");
        Byid("ida_chegada_hora").value = "11:55";
        // volta
        Byid("volta_data").value = new Date(Date.now() + 5 * 24 * 3600 * 1000)
          .toISOString()
          .split("T")[0];
  Byid("volta_num").value = "4321";
  setSelectByLabel(Byid("volta_partida_aero"), "Recife (REC)");
        Byid("volta_partida_hora").value = "13:00";
  setSelectByLabel(Byid("volta_chegada_aero"), "S√£o Paulo - Guarulhos (GRU)");
        Byid("volta_chegada_hora").value = "16:35";
        
        // gerar visual
        gerarDeclaracao();
      }

      function escapeHtml(str) {
        return (str + "").replace(/[&<>\"]/g, function (c) {
          return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
        });
      }

      // ===== Parser para importar linhas no formato especificado =====
      /**
       * Exemplo de linha:
       * 1 G33689Y 17OCT VIXGIG HK1 2030 2135 /RLLA*AUKLWM/E
       * Campos relevantes: (ignore o primeiro d√≠gito e o bloco da companhia)
       * - n√∫mero do voo: os 4 d√≠gitos ap√≥s a companhia (por exemplo 3689 dentro de G33689Y -> 3689)
       * - data: 17OCT (dia + m√™s abreviado)
       * - origem/destino: VIXGIG (origem 3 letras + destino 3 letras)
       * - hor√°rios: sa√≠da e chegada (2030, 2135)
       */
      function parseTrechoLine(line) {
        if (!line) return null;
        // normaliza espa√ßos
        const parts = line.trim().split(/\s+/);
        // procura por um token que contenha letras+digitos tipo G33689Y
        let flightToken = parts.find((p) => /[A-Z]\d{3,}/i.test(p));
        if (!flightToken) {
          // fallback: tenta o segundo token
          flightToken = parts[1] || parts[0];
        }
        // extrair 4 d√≠gitos cont√≠guos do token
        const flightDigits = (flightToken.match(/\d{4}/) || [])[0] || "";

        // data token (ex: 17OCT)
        const dateToken =
          parts.find((p) => /^[0-9]{1,2}[A-Z]{3}$/i.test(p)) || "";
        // origem/destino token (6 letras juntas ou dois tokens de 3)
        let odToken = parts.find((p) => /^[A-Z]{6}$/i.test(p));
        if (!odToken) {
          // tenta juntar pr√≥ximo token
          const idx = parts.indexOf(dateToken);
          if (idx >= 0 && parts[idx + 1]) {
            // se o token depois da data tiver 6 letras
            if (/^[A-Z]{6}$/i.test(parts[idx + 1])) odToken = parts[idx + 1];
            else if (
              /^[A-Z]{3}$/i.test(parts[idx + 1]) &&
              /^[A-Z]{3}$/i.test(parts[idx + 2] || "")
            )
              odToken = parts[idx + 1] + parts[idx + 2];
          }
        }

        // hor√°rios: procura por dois tokens com 3 ou 4 d√≠gitos
        const timeCandidates = parts.filter((p) => /^\d{3,4}$/.test(p));
        let depart = timeCandidates[0] || "";
        let arrive = timeCandidates[1] || timeCandidates[0] || "";

        // normaliza√ß√µes
        const number = flightDigits.padStart(4, "0");
        const origem = odToken ? odToken.slice(0, 3) : "";
        const destino = odToken ? odToken.slice(3, 6) : "";

        // data: converte 17OCT para YYYY-MM-DD aproximado no ano atual
        let isoDate = "";
        if (dateToken) {
          const day = parseInt(dateToken.slice(0, -3), 10);
          const mon = dateToken.slice(-3).toUpperCase();
          const monthMap = {
            JAN: 1,
            FEB: 2,
            MAR: 3,
            APR: 4,
            MAY: 5,
            JUN: 6,
            JUL: 7,
            AUG: 8,
            SEP: 9,
            OCT: 10,
            NOV: 11,
            DEC: 12,
          };
          const m = monthMap[mon] || NaN;
          if (!isNaN(m) && day >= 1 && day <= 31) {
            const y = new Date().getFullYear();
            isoDate = `${y.toString().padStart(4, "0")}-${String(m).padStart(
              2,
              "0"
            )}-${String(day).padStart(2, "0")}`;
          }
        }

        function fmtTime(t) {
          if (!t) return "";
          const s = t.padStart(4, "0");
          return `${s.slice(0, 2)}:${s.slice(2, 4)}`;
        }

        return {
          number,
          date: isoDate,
          origem: origem ? `${origem} (${origem})` : "",
          destino: destino ? `${destino} (${destino})` : "",
          depart: fmtTime(depart),
          arrive: fmtTime(arrive),
          raw: line,
        };
      }

      function importarTrechosFromTextarea() {
        const ta = Byid("import_text");
        if (!ta) return;
        const lines = ta.value
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter(Boolean);
        if (!lines.length) return alert("Cole pelo menos uma linha v√°lida.");
        const parsed = lines.map(parseTrechoLine).filter(Boolean);
        if (!parsed.length)
          return alert(
            "N√£o foi poss√≠vel parsear as linhas. Verifique o formato."
          );

        // popula o primeiro trecho na se√ß√£o de ida
        const first = parsed[0];
  if (first.date) Byid("ida_data").value = first.date;
  if (first.number) Byid("ida_num").value = first.number;
  if (first.origem) setSelectByLabel(Byid("ida_partida_aero"), first.origem);
  if (first.depart) Byid("ida_partida_hora").value = first.depart;
  if (first.destino) setSelectByLabel(Byid("ida_chegada_aero"), first.destino);
  if (first.arrive) Byid("ida_chegada_hora").value = first.arrive;

        // se houver mais linhas, transforme em conex√µes
        if (parsed.length > 1) {
          Byid("ida_conexoes_count").value = String(parsed.length - 1);
          renderConexoes("ida", parsed.length - 1);
          for (let i = 1; i < parsed.length; i++) {
            const p = parsed[i];
            if (p.number) Byid(`ida_num_${i - 1}`).value = p.number;
            if (p.origem) setSelectByLabel(Byid(`ida_partida_aero_${i - 1}`), p.origem);
            if (p.depart) Byid(`ida_partida_hora_${i - 1}`).value = p.depart;
            if (p.destino) setSelectByLabel(Byid(`ida_chegada_aero_${i - 1}`), p.destino);
            if (p.arrive) Byid(`ida_chegada_hora_${i - 1}`).value = p.arrive;
          }
        }
        gerarDeclaracao();
      }

      // ---- Render inicial (garante estado consistente ao carregar) ----
      (function init() {
        // data da declara√ß√£o
        const declaracaoDate = Byid("declaracao_date");
        if (declaracaoDate && !declaracaoDate.value)
          declaracaoDate.value = new Date().toISOString().split("T")[0];

        const qIda = Math.max(0, Number(ida_conexoes_count?.value || 0));
        const qVolta = Math.max(0, Number(volta_conexoes_count?.value || 0));
        renderConexoes("ida", qIda);
        renderConexoes("volta", qVolta);

        function limparFormulario() {
          // Limpa campos do cabe√ßalho
          Byid("OouA").value = "";
          Byid("nome").value = "";
          Byid("localizador").value = "";

          // Reseta tipo de viagem
          Byid("tipo_viagem_select").value = "";
          marcadoida();

          // Limpa campos de ida
          Byid("ida_data").value = "";
          Byid("ida_num").value = "";
          Byid("ida_partida_aero").value = "";
          try { Byid("ida_partida_aero").dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
          Byid("ida_partida_hora").value = "";
          Byid("ida_chegada_aero").value = "";
          try { Byid("ida_chegada_aero").dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
          Byid("ida_chegada_hora").value = "";

          // Reseta conex√µes ida
          Byid("ida_conexoes_count").value = "0";
          renderConexoes("ida", 0);

          // Limpa campos de volta
          Byid("volta_data").value = "";
          Byid("volta_num").value = "";
          Byid("volta_partida_aero").value = "";
          try { Byid("volta_partida_aero").dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
          Byid("volta_partida_hora").value = "";
          Byid("volta_chegada_aero").value = "";
          try { Byid("volta_chegada_aero").dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
          Byid("volta_chegada_hora").value = "";

          // Reseta conex√µes volta
          Byid("volta_conexoes_count").value = "0";
          renderConexoes("volta", 0);


          // Limpa preview
          const preview = Byid("preview");
          if (preview) preview.textContent = "";
        }

        // hookup buttons
        const bGerar = Byid("btn_gerar");
        if (bGerar)
          bGerar.addEventListener("click", (e) => {
            e.preventDefault();
            gerarDeclaracao();
          });
        const bCopiar = Byid("btn_copiar");
        if (bCopiar)
          bCopiar.addEventListener("click", async () => {
            const ok = await copiarPreview();
            if (ok) {
              alert("Texto copiado para a √°rea de transfer√™ncia");
            } else {
              alert("N√£o foi poss√≠vel copiar");
            }
          });
        const bImprimir = Byid("btn_imprimir");
        if (bImprimir)
          bImprimir.addEventListener("click", () => {
            imprimirPreview();
          });
        const bBaixar = Byid("btn_baixar");
        if (bBaixar)
          bBaixar.addEventListener("click", () => {
            baixarTxt();
          });
        const bEx = Byid("btn_exemplo");
        if (bEx)
          bEx.addEventListener("click", () => {
            carregarExemplo();
          });

        // Bot√£o Importar
        const bImport = Byid("btn_importar");
        if (bImport) bImport.addEventListener("click", () => importarTrechosFromTextarea());

        // Bot√£o Limpar
        const bLimpar = Byid("btn_limpar");
        if (bLimpar)
          bLimpar.addEventListener("click", () => {
            if (
              confirm("Deseja realmente limpar todos os campos do formul√°rio?")
            ) {
              limparFormulario();
            }
          });
      })();
      // ===== Utilit√°rios de formata√ß√£o/valida√ß√£o =====

      // 1) Localizador: 6 caracteres mai√∫sculos (alfa-num√©rico)
      function normalizeLocalizador(v) {
        if (!v) return "";
        return v
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "")
          .slice(0, 6);
      }
      function isValidLocalizador(v) {
        return /^[A-Z0-9]{6}$/.test(v);
      }

      // 2) Nome: primeira letra mai√∫scula e restante min√∫sculo
      function formatPassengerName(v) {
        if (!v) return "";
        return v
          .toString()
          .trim()
          .split(/\s+/)
          .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1).toLowerCase() : ""))
          .join(" ");
      }

      // 3) Data: "01 de Janeiro de 2025"
      function formatDateLong(yyyy_mm_dd) {
        if (!yyyy_mm_dd) return "";
        const [y, m, d] = yyyy_mm_dd.split("-").map(Number);
        if (!y || !m || !d) return "";
        const meses = [
          "Janeiro",
          "Fevereiro",
          "Mar√ßo",
          "Abril",
          "Maio",
          "Junho",
          "Julho",
          "Agosto",
          "Setembro",
          "Outubro",
          "Novembro",
          "Dezembro",
        ];
        const dd = String(d).padStart(2, "0");
        const mes = meses[m - 1] || "";
        return `${dd} de ${mes} de ${y}`;
      }

      // 4) N√∫mero do voo: sempre 4 d√≠gitos
      function onlyDigits(v) {
        return (v || "").replace(/\D/g, "");
      }
      function fourDigitFlight(v) {
        // Mant√©m s√≥ d√≠gitos e for√ßa 4 d√≠gitos (com zero √† esquerda, se necess√°rio)
        const d = onlyDigits(v).slice(0, 4);
        return d.padStart(4, "0");
      }
      function isValidFourDigit(v) {
        return /^\d{4}$/.test(v);
      }

      // 5) Hor√°rio: fun√ß√£o de normaliza√ß√£o consolidada definida mais abaixo
      function formatTimeHhMm(v) {
        // recebe "23:59" e devolve "23h59"
        if (!v) return "";
        const norm = normalizeTimeToHHMM(v);
        if (!norm) return "";
        const [hh, mm] = norm.split(":");
        return `${hh}h${mm}`;
      }

      // ===== Listeners para higienizar enquanto digita =====
      document.addEventListener("DOMContentLoaded", () => {
        // a) Localizador
        const localizador = Byid("localizador");
        if (localizador) {
          localizador.addEventListener("input", () => {
            const cur = localizador.selectionStart; // tenta preservar caret
            const val = normalizeLocalizador(localizador.value);
            localizador.value = val;
            // reposiciona caret ao fim
            localizador.setSelectionRange(val.length, val.length);
          });
        }

        // b) Nome do passageiro
        const nome = Byid("nome");
        if (nome) {
          nome.addEventListener("blur", () => {
            nome.value = formatPassengerName(nome.value);
          });
        }

        // c) N√∫meros de voo fixos (ida e volta)
        const ida_num = Byid("ida_num");
        if (ida_num) {
          ida_num.addEventListener("input", () => {
            ida_num.value = onlyDigits(ida_num.value).slice(0, 4);
          });
        }
        const volta_num = Byid("volta_num");
        if (volta_num) {
          volta_num.addEventListener("input", () => {
            volta_num.value = onlyDigits(volta_num.value).slice(0, 4);
          });
        }

        // d) N√∫meros de voo das conex√µes (delegado para ida/volta)
        const ida_conexoes_container = Byid("ida_conexoes_container");
        if (ida_conexoes_container) {
          ida_conexoes_container.addEventListener("input", (e) => {
            const el = e.target;
            if (el && /^ida_num_\d+$/.test(el.id)) {
              el.value = onlyDigits(el.value).slice(0, 4);
            }
          });
        }
        const volta_conexoes_container = Byid("volta_conexoes_container");
        if (volta_conexoes_container) {
          volta_conexoes_container.addEventListener("input", (e) => {
            const el = e.target;
            if (el && /^volta_num_\d+$/.test(el.id)) {
              el.value = onlyDigits(el.value).slice(0, 4);
            }
          });
        }

        // f) Preencher data da declara√ß√£o com hoje (mantendo type="date")
        const declaracaoDate = Byid("declaracao_date");
        if (declaracaoDate && !declaracaoDate.value) {
          declaracaoDate.value = new Date().toISOString().split("T")[0];
        }
      });

      // ===== Valida√ß√£o antes de gerar =====
      function validateRules() {
        const errors = [];

        const loc = Byid("localizador")?.value || "";
        if (!isValidLocalizador(loc)) {
          errors.push(
            "C√≥digo localizador deve ter 6 caracteres alfa-num√©ricos em MAI√öSCULO (ex.: ABC123)."
          );
        }

        const idaNum = Byid("ida_num")?.value || "";
        if (!isValidFourDigit(onlyDigits(idaNum).padStart(4, "0"))) {
          errors.push("N√∫mero do voo (ida) deve conter 4 d√≠gitos (ex.: 0123).");
        }

        const voltaNumEl = Byid("volta_num");
        if (voltaNumEl && Byid("tipo_viagem_select")?.value === "ida/volta") {
          const v = voltaNumEl.value || "";
          if (!isValidFourDigit(onlyDigits(v).padStart(4, "0"))) {
            errors.push(
              "N√∫mero do voo (volta) deve conter 4 d√≠gitos (ex.: 0456)."
            );
          }
        }

        // Conex√µes IDA
        const qIda = Number(Byid("ida_conexoes_count")?.value || 0);
        for (let i = 0; i < qIda; i++) {
          const v = Byid(`ida_num_${i}`)?.value || "";
          if (!isValidFourDigit(onlyDigits(v).padStart(4, "0"))) {
            errors.push(
              `N√∫mero do voo da conex√£o ${i + 1} (ida) deve conter 4 d√≠gitos.`
            );
          }
        }

        // Conex√µes VOLTA
        const qVolta = Number(Byid("volta_conexoes_count")?.value || 0);
        const tipo = Byid("tipo_viagem_select")?.value;
        if (tipo === "ida/volta") {
          for (let i = 0; i < qVolta; i++) {
            const v = Byid(`volta_num_${i}`)?.value || "";
            if (!isValidFourDigit(onlyDigits(v).padStart(4, "0"))) {
              errors.push(
                `N√∫mero do voo da conex√£o ${
                  i + 1
                } (volta) deve conter 4 d√≠gitos.`
              );
            }
          }
        }

        // Hor√°rios: aceitar HH:MM no input, mas precisam ser v√°lidos
        const timeIds = ["ida_partida_hora", "ida_chegada_hora"];
        if (tipo === "ida/volta")
          timeIds.push("volta_partida_hora", "volta_chegada_hora");
        for (const id of timeIds) {
          const el = Byid(id);
          if (el) {
            const norm = normalizeTimeToHHMM(el.value);
            if (!norm)
              errors.push(
                `Hor√°rio inv√°lido em "${id}". Use formato HH:MM (ex.: 23:59).`
              );
          }
        }

        return errors;
      }

      // ===== Ajuste nas fun√ß√µes de gera√ß√£o de texto =====
      function textoInicial() {
        const cidade = Byid("cidade")?.value || "";
        const dataDeclRaw = Byid("declaracao_date")?.value || "";
        const dataDeclFmt = formatDateLong(dataDeclRaw);
        return `${cidade}, ${dataDeclFmt}`;
      }

      function textodaida() {
        // Normaliza√ß√µes exigidas
        const nomeFmt = formatPassengerName(Byid("nome")?.value || "");
        const OouAEl = Byid("OouA");
        // pega o valor (O ou A), remove espa√ßos e for√ßa mai√∫scula; padr√£o 'O'
        const OouAV = (OouAEl?.value || "o").toString().trim();
        const localizadorFmt = normalizeLocalizador(
          Byid("localizador")?.value || ""
        );
        const companhia = Byid("companhia")?.value || "GOL Linhas A√©reas S.A";

        const ida_data_raw = Byid("ida_data")?.value || "";
        const ida_data_fmt = formatDateLong(ida_data_raw);

        const ida_num_fmt = fourDigitFlight(Byid("ida_num")?.value || "");
  const ida_partida_sel = Byid("ida_partida_aero");
  const ida_partida_aero_v = (ida_partida_sel?.selectedOptions?.[0]?.textContent) || ida_partida_sel?.value || "";
        const ida_partida_hora_fmt = formatTimeHhMm(
          Byid("ida_partida_hora")?.value || ""
        );
  const ida_chegada_sel = Byid("ida_chegada_aero");
  const ida_chegada_aero_v = (ida_chegada_sel?.selectedOptions?.[0]?.textContent) || ida_chegada_sel?.value || "";
        const ida_chegada_hora_fmt = formatTimeHhMm(
          Byid("ida_chegada_hora")?.value || ""
        );

        let texto =
          `\n\n\nFazemos refer√™ncia, por ora, que ${OouAV} Sr.(a) ${nomeFmt} possu√≠a a passagem de c√≥digo ` +
          `localizador ${localizadorFmt} e embarcou com a companhia ${companhia}, sendo o voo de ` +
          `ida no dia ${ida_data_fmt}, no voo G3 ${ida_num_fmt}, partindo do ${ida_partida_aero_v} √†s ${ida_partida_hora_fmt}, ` +
          `chegando em ${ida_chegada_aero_v} √†s ${ida_chegada_hora_fmt}`;

        const qtdCon = Number(Byid("ida_conexoes_count")?.value || 0);
        for (let i = 0; i < qtdCon; i++) {
          const v = fourDigitFlight(Byid(`ida_num_${i}`)?.value || "");
          const oel = Byid(`ida_partida_aero_${i}`);
          const o = (oel?.selectedOptions?.[0]?.textContent) || oel?.value || "";
          const hs = formatTimeHhMm(Byid(`ida_partida_hora_${i}`)?.value || "");
          const del = Byid(`ida_chegada_aero_${i}`);
          const d = (del?.selectedOptions?.[0]?.textContent) || del?.value || "";
          const hc = formatTimeHhMm(Byid(`ida_chegada_hora_${i}`)?.value || "");
          texto += `, com conex√£o no voo G3 ${v}, partindo de ${o} √†s ${hs}, chegando em ${d} √†s ${hc}`;
        }

        return texto;
      }

      function textodavolta() {
        const volta_data_fmt = formatDateLong(Byid("volta_data")?.value || "");
        const volta_num_fmt = fourDigitFlight(Byid("volta_num")?.value || "");
  const volta_partida_sel = Byid("volta_partida_aero");
  const volta_partida_aero_v = (volta_partida_sel?.selectedOptions?.[0]?.textContent) || volta_partida_sel?.value || "";
        const volta_partida_hora_fmt = formatTimeHhMm(
          Byid("volta_partida_hora")?.value || ""
        );
  const volta_chegada_sel = Byid("volta_chegada_aero");
  const volta_chegada_aero_v = (volta_chegada_sel?.selectedOptions?.[0]?.textContent) || volta_chegada_sel?.value || "";
        const volta_chegada_hora_fmt = formatTimeHhMm(
          Byid("volta_chegada_hora")?.value || ""
        );

        let texto =
          `\n\nE o voo de volta no dia ${volta_data_fmt}, no voo G3 ${volta_num_fmt}, partindo de ${volta_partida_aero_v} √†s ` +
          `${volta_partida_hora_fmt}, chegando em ${volta_chegada_aero_v} √†s ${volta_chegada_hora_fmt}`;

        const qtdCon = Number(Byid("volta_conexoes_count")?.value || 0);
        for (let i = 0; i < qtdCon; i++) {
          const v = fourDigitFlight(Byid(`volta_num_${i}`)?.value || "");
          const oel = Byid(`volta_partida_aero_${i}`);
          const o = (oel?.selectedOptions?.[0]?.textContent) || oel?.value || "";
          const hs = formatTimeHhMm(
            Byid(`volta_partida_hora_${i}`)?.value || ""
          );
          const del = Byid(`volta_chegada_aero_${i}`);
          const d = (del?.selectedOptions?.[0]?.textContent) || del?.value || "";
          const hc = formatTimeHhMm(
            Byid(`volta_chegada_hora_${i}`)?.value || ""
          );
          texto += `, com conex√£o no voo G3 ${v}, partindo de ${o} √†s ${hs}, chegando em ${d} √†s ${hc}`;
        }

        return texto;
      }

      // ===== Integre com seu bot√£o "Gerar Declara√ß√£o" =====
      document.addEventListener("DOMContentLoaded", () => {
        const btnGerar = Byid("btn_gerar");
        const preview = Byid("preview");
        if (btnGerar && preview) {
          btnGerar.addEventListener("click", (e) => {
            e.preventDefault();
            const errs = validateRules();
            if (errs.length) {
              preview.innerHTML = `<strong>Corrija os seguintes itens:</strong><br>- ${errs.join(
                "<br>- "
              )}`;
              return;
            }
            const tipo = Byid("tipo_viagem_select")?.value;
            const partes = [textoInicial(), textodaida()];
            if (tipo === "ida/volta") partes.push(textodavolta());
            preview.innerHTML = partes.filter(Boolean).join(". ") + ".";
          });
        }
      });

      const rawAeroportos = `
2. Alta Floresta - AFL
3. Altamira - ATM
4. Aracaju - AJU
5. Araguaina - AUX
6. Arax√° - AAX
7. Ara√ßatuba - ARU
8. Barreiras - BRA
9. Barretos - BAT
10. Bauru - Arealva - JTC
11. Belo Horizonte - Confins - CNF
12. Belo Horizonte - Pampulha - PLU
14. Bel√©m - BEL
15. Boa Vista - BVB
16. Boipeba - PBA
17. Bonito - BYO
18. Bras√≠lia - BSB
19. Cabo Frio - CFB
20. Cacoal - OAL
21. Caldas Novas - CLV
22. Campina Grande - CPV
23. Campo Grande - CGR
24. Campos dos Goitacazes - CAW
25. Canoas - QNS
26. Caruaru - CAU
27. Cascavel - CAC
28. Caxias do Sul - Gramado e Canela - CXJ
29. Chapec√≥ - XAP
30. Corumb√° - CMG
31. Cruzeiro do Sul - CZS
32. Cuiab√° - CGB
33. Curitiba - CWB
34. Dourados - DOU
35. Eirunep√© - ERN
36. Feira de Santana - FEC
37. Fernando de Noronha - FEN
38. Florian√≥polis - FLN
39. Fortaleza - FOR
40. Foz do Igua√ßu ‚Äì Iguazu Falls - IGU
41. Franca - FRC
42. Goi√¢nia - GYN
43. Governador Valadares - GVR
44. Guanambi - GNM
45. Guarapuava - GPB
46. Ilh√©us - IOS
47. Imperatriz - IMP
48. Ipatinga / Vale do A√ßo - IPN
49. Itaituba - ITB
50. Jaguaruna - Crici√∫ma - JJG
51. Jericoacoara - JJD
52. Ji-Paran√° - JPR
53. Joinville - JOI
54. Jo√£o Pessoa - JPA
55. Juazeiro do Norte - JDO
56. Juiz de Fora - IZA
57. Lages - Correia Pinto - EEA
58. Len√ß√≥is/Chapada Diamantina - LEC
59. Londrina - LDB
60. Macap√° - MCP
61. Macei√≥ - MCZ
62. Manaus - MAO
63. Marab√° - MAB
64. Maring√° - MGF
65. Mar√≠lia - MII
66. Montes Claros - MOC
67. Morro de S√£o Paulo - MXQ
68. Mossor√≥ - MVF
69. Mucug√™ - CHD
70. Natal - NAT
71. Navegantes - NVT
72. Palmas - PMW
73. Parauapebas - Caraj√°s - CKS
74. Parintins - PIN
75. Parna√≠ba - PHB
76. Passo Fundo  - PFB
77. Pato Branco - PTO
78. Patos de Minas - POJ
79. Paulo Afonso - PAV
80. Pelotas - PET
81. Pen√≠nsula de Mara√∫ - MUU
82. Petrolina - PNZ
83. Ponta Grossa - PGZ
84. Ponta Por√£ - PMG
85. Porto Alegre - POA
86. Porto Seguro - BPS
87. Porto Trombetas - TMT
88. Porto Velho - PVH
89. Presidente Prudente - PPB
90. Recife - REC
91. Ribeir√£o Preto - RAO
92. Rio Branco - RBR
93. Rio Verde - RVD
94. Rio de Janeiro - Gale√£o - GIG
95. Rio de Janeiro - Santos Dumont - SDU
97. Rondon√≥polis - ROO
98. Salvador - SSA
99. Santa Maria - RIA
100. Santar√©m - STM
101. Santo √Çngelo - GEL
102. Sinop - OPS
103. Sobral - QBX
104. Sorriso - SMT
105. S√£o Benedito - QXY
106. S√£o Gabriel da Cachoeira - SJL
107. S√£o Jos√© do Rio Preto - Ol√≠mpia - SJP
109. S√£o Paulo - Campinas - Viracopos - VCP
110. S√£o Paulo - Congonhas - CGH
111. S√£o Paulo - Guarulhos - GRU
112. S√£o Paulo - S√£o Jos√© dos Campos - SJK
113. S√£o Paulo - Todos os aeroportos - SAO
114. S√£o Raimundo Nonato - NSR
115. Tabatinga - TBT
116. Tef√© - TFF
117. Teresina - THE
118. Tr√™s Lagoas - TJL
119. Uberaba - UBA
120. Uberl√¢ndia - UDI
121. Una-Comandatuba - UNA
122. Uruguaiana - URG
123. Vilhena - BVH
124. Vit√≥ria - VIX
125. Vit√≥ria da Conquista - VDC

127. Aalborg Airport - AAL
128. Aberdeen - ABZ
129. Abidjan, Ivory Coast - ABJ
130. Abuja, Nigeria - ABV
131. Accra - ACC
132. Aeroporto Cap Carlos Perez - VSA
133. Aeroporto Internacional de Piarco - POS
134. Agadir, Morocco - AGA
135. Al Ain - Terminal de Onibus - AAN
136. Albany - ALB
137. Alesund - AES
138. Antofagasta - ANF
139. Arauca - AUC
140. Arica - Arica y Parinacota - ARI
141. Arm√™nia - AXM
142. Aruba - AUA
143. Assun√ß√£o - ASU
144. Athens - Eleftherios Venizelos - ATH
145. Atlanta - ATL
146. Austin - AUS
147. Ayacucho - AYP
148. B Diagne Int Dkr, Senegal - DSS
149. Bahia Blanca - BHI
150. Balmaceda - Ays√©n del General Carlos Ib√°√±ez del Campo - BBA
151. Baltimore - BWI
152. Bamako, Mali - BKO
153. Banjul, Gambia - BJL
154. Barbados - BGI
155. Barcelona - El Prat - BCN
156. Bariloche  - BRC
157. Barrancabermeja - EJA
158. Barranquilla - BAQ
159. Bergen - BGO
160. Berlin - Brandenburg Airport - BER
161. Bilbao - BIO
162. Billund Airport - BLL
163. Birmingham - BHX
164. Birmingham Alabama - BHM
165. Bissau, Guinea Bissau - OXB
166. Bogot√° - BOG
167. Bolonha - BLQ
168. Bordeaux Airport - BOD
169. Boston - BOS
170. Bremen Airport - BRE
171. Brest - BES
172. Bristol - BRS
173. Bucaramanga - BGA
174. Buenos Aires - Aeroparque - AEP
175. Buenos Aires - Ezeiza - EZE
177. Buffalo - BUF
178. Cairo, Egypt - CAI
179. Calama - Antofagasta - CJC
180. Cali - CLO
181. Canc√∫n - CUN
182. Caracas - CCS
183. Cardiff - CWL
184. Cartagena - CTG
185. Casablanca, Morocco - CMN
186. Castro - Dalcahue - Chilo√© Island - Los Lagos - MHC
187. Catamarca - CTC
188. Cayenne - F√©lix Ebou√© - CAY
189. Cedar Rapids - CID
190. Charleston - CHS
191. Charlotte - CLT
192. Chicago - ORD
193. Cidade do Cabo - CPT
194. Cidade do M√©xico - MEX
195. Cidade do Panam√° - PTY
196. Cincinnati - CVG
197. Clermont-Ferrand - CFE
198. Cleveland - CLE
199. Cochabamba - CBB
200. Columbus - CMH
201. Comodoro Rivadavia - CRD
202. Conakry, Guinea - CKY
203. Concepci√≥n - B√≠o B√≠o - CCP
204. Copenhagen Airport - CPH
205. Copiap√≥ - Atacama - CPO
206. Corrientes - CNQ
207. Cotonou, Benin - COO
208. Cuenca - CUE
209. Cura√ßao - CUR
210. Cusco - CUZ
211. C√≥rdoba - COR
212. C√∫cuta - CUC
213. Dakhla, Morocco - VIL
214. Dallas - Fort Worth - DFW
215. Deer Lake - YDF
216. Denver - DEN
217. Des Moines - DSM
218. Detroit - DTW
219. Dubai ‚Äì Terminal de Onibus - XNB
220. Dublin Airport - DUB
221. Duesseldorf International - DUS
222. Durban - DUR
223. Durham - MME
224. Eagle County Airport - EGE
225. Edinburgh - EDI
226. Edmonton - YEG
227. El Calafate - FTE
228. El Yopal - EYP
229. Errachidla, Morocco - ERH
230. Esquel - EQS
231. Estocolmo Arlanda - ARN
232. EuroAirport Swiss - BSL
233. Fayetteville Northwest Arkansas - XNA
234. Fez, Morocco - FEZ
235. Filadelfia - PHL
236. Floren√ßa - FLR
237. Flores - FRS
238. Formosa - FMA
239. Fort Lauderdale - FLL
240. Fort-de-France - Martinica - FDF
241. Forte McMurray - YMM
242. Frankfurt International Airport - FRA
243. Fredericton - YFC
244. Freetown Lungi, Sierra Leone - FNA
245. Geneva - GVA
246. Genova - GOA
247. Georgetown - GEO
248. Glasgow - GLA
249. Gotemburgo Landvetter - GOT
250. Grand Rapids - GRR
251. Greensboro - GSO
252. Greenville Spartanburg - GSP
253. Guadalajara - GDL
254. Guatemala - GUA
255. Guayaquil - GYE
256. Halifax - YHZ
257. Hamburg Airport - HAM
258. Hannover Airport - HAJ
259. Hartford Springfield - BDL
260. Havana - HAV
261. Honolulu International Airport - HNL
262. Houston - IAH
264. Humberside - HUY
265. Ibagu√© - IBE
266. Iguazu - IGR
267. Ilhas Gal√°pagos - GPS
268. Indianapolis - IND
269. Ipiales - IPI
270. Iquique - Tarapac√° - IQQ
271. Iquitos - Loreto - IQT
272. Istambul - IST
273. Jacksonville - JAX
274. Jauja - Jun√≠n - JAU
275. Johannesburg - JNB
276. Jujuy - JUJ
277. Juliaca - Puno - JUL
278. Kansas City Missouri - MCI
279. Key West - EYW
280. Kingston - KIN
281. Knoxville - TYS
282. Kristiansand - KRS
283. La Paz ‚Äì El Alto - LPB
284. La Rioja - IRJ
285. La Serena - Coquimbo - LSC
286. Laayoune, Morocco - EUN
287. Lagos, Nigeria - LOS
288. Las Vegas - LAS
289. Leeds/Bradford - LBA
290. Leticia - LET
291. Le√≥n - BJX
292. Lima - LIM
293. Linkoping Airport - LPI
294. Lisboa - LIS
295. Little Rock - LIT
296. Lome, Togo - LFW
297. London - Heathrow - LHR
298. Los Angeles - LAX
299. Louisville - SDF
300. Luanda - LAD
301. Lyon Satolas Airport - LYS
302. Madison - MSN
303. Madrid - Barajas - MAD
304. Manchester - MAN
305. Manta - MEC
306. Man√°gua - MGA
307. Maputo - MPM
308. Mar del Plata - MDQ
309. Maracaibo - MAR
310. Marrakech, Morocco - RAK
311. Marseille - MRS
312. Medell√≠n - MDE
313. Memphis - MEM
314. Mendoza - MDZ
315. Miami - MIA
316. Milwaukee - MKE
317. Mil√£o - Linate - LIN
318. Mil√£o - Malpensa - MXP
319. Minneapolis - MSP
320. Moncton - YQM
321. Monrovia Roberts, Liberia - ROB
322. Montego Bay - MBJ
323. Monterrey - MTY
324. Monter√≠a - MTR
325. Montevid√©u - MVD
326. Montpellier - MPL
327. Montreal - YMQ
328. Montreal - YUL
329. Munich International - MUC
330. Nador, Morocco - NDR
331. Nantes - NTE
332. Napoles - NAP
333. Nashville - BNA
334. Nassau - NAS
335. Neiva - NVA
336. Neuquen - NQN
337. New Orleans - MSY
338. Newcastle - NCL
339. Niamey, Niger - NIM
340. Nice - NCE
341. Norfolk Virginia - ORF
342. Norwich - NWI
343. Nouakchott, Mauritania - NKC
344. Nova Iorque - John F. Kennedy - JFK
345. Nova Iorque - La Guardia - LGA
346. Nova Iorque - Newark - EWR
348. Nuremberg Airport - NUE
349. Oakland - OAK
350. Oklahoma City - OKC
351. Omaha - OMA
352. Ont√°rio - Calif√≥rnia - ONT
353. Orlando - MCO
354. Oslo Gardemoen - OSL
355. Oslo Sandefjord - TRF
356. Osorno - Los Lagos - ZOS
357. Ottawa - YOW
358. Ouagadougou, Burkina Faso - OUA
359. Ouarzazate, Morocco - OZZ
360. Oujda, Morocco - OUD
361. Paramaribo - PBM
362. Paris - Charles De Gaulle - CDG
364. Pau - PUF
365. Pensacola - PNS
366. Pereira - PEI
367. Phoenix - PHX
368. Pittsburgh - PIT
369. Piura - PIU
370. Pointe-a-Pitre, Guadeloupe - PTP
371. Ponta Negra - PNR
372. Popay√°n - PPN
373. Port Elizabeth - PLZ
374. Portland - PDX
375. Porto - OPO
376. Porto Pr√≠ncipe - PAP
377. Posadas - PSS
378. Praia, Cape Verde - RAI
379. Pucallpa - Ucayali - PCL
380. Puerto Maldonado - Madre de Dios - PEM
381. Puerto Montt - Los Lagos - PMC
382. Puerto Natales - Magallanes y de la Ant√°rtica Chilena - PNT
383. Punta Arenas - Magallanes y de la Ant√°rtica Chilena - PUQ
384. Punta Cana - PUJ
385. Punta Del Este - PDP
386. Quebec - YQB
387. Quibd√≥ - UIB
388. Quinxassa - FIH
389. Quito - UIO
390. Raleigh/Durham - RDU
391. Regina - YQR
392. Rennes - RNS
393. Resistencia - RES
394. Rhodes, Rhodos Island - RHO
395. Richmond - RIC
396. Rio Gallegos - RGL
397. Rio Grande - RGA
398. Rio Hondo - RHD
399. Riohacha - RCH
400. Rochester - ROC
401. Rodriguez Ballon Airport - AQP
403. Roma ‚Äì Fiumicino - FCO
404. Rosario - ROS
405. Sacramento - SMF
406. Saint Croix - STX
407. Saint Louis - STL
408. Saint Thomas - STT
409. Sal, Cape Verde - SID
410. Salt Lake City - SLC
411. Salta - SLA
412. Salto da Santa Maria - YAM
413. San Andr√©s - ADZ
414. San Antonio - SAT
415. San Cristobal ‚Äì Ilhas Gal√°pagos - SCY
416. San Diego - SAN
417. San Jos√© - Calif√≥rnia - SJC
418. San Jos√© - Costa Rica - SJO
419. San Jos√© del Cabo - SJD
420. San Juan - SJU
421. San Juan - UAQ
422. San Juan de Pasto - PSO
423. San Luis - LUQ
424. San Mart√≠n de los Andes - CPC
425. San Pedro Sula - SAP
426. San Rafael - AFA
427. San Salvador - SAL
428. Santa Cruz de la Sierra - VVI
429. Santa Fe - SFN
430. Santa Marta - SMR
431. Santa Rosa - RSA
432. Santana do Livramento - RVY
433. Santiago - SCL
434. Santiago del Estero - SDE
435. Santo Domingo - SDQ
436. Savannah - SAV
437. Schiphol Airport - AMS
438. Seattle - SEA
439. Sevilha - SVQ
440. Stavanger - SVG
441. Stuttgart Airport - STR
442. Sucre Airport - SRE
443. Sudbury - YSB
444. Sydney - YQY
445. Syracuse - SYR
446. S√£o Francisco - SFO
447. S√£o Jo√£o da Terra Nova - YSJ
448. S√£o Martinho - SXM
449. Tacna - TCQ
450. Tampa - TPA
451. Tangier, Morocco - TNG
452. Tarapoto - San Mart√≠n - TPP
453. Tegucigalpa - XPL
454. Temuco - Araucan√≠a - ZCO
455. Thunder Bay - YQT
456. Tijuana - TIJ
457. Timmins - YTS
458. Tobago - TAB
459. Toronto - YTO
460. Toronto - YYZ
461. Toulouse - TLS
462. Trelew - REL
463. Trondheim - TRD
464. Trujillo - La Libertad - TRU
465. Tucuman - TUC
466. Tulsa - TUL
467. Tulum - TQO
468. Tumbes - TBP
469. Tunis, Tunisia - TUN
470. Turin - TRN
471. Ushuaia - USH
472. Valdivia - Los R√≠os - ZAL
473. Valledupar - VUP
474. Val√™ncia - VLC
475. Vancouver - YVR
476. Veneza - VCE
477. Viedma - VDM
478. Villavicencio - VVC
479. Washington - Dulles - IAD
480. Washington - Ronald Reagan - DCA
482. Wichita - ICT
483. Windhoek - WDH
484. Windsor - YQG
485. Winnipeg - YWG
486. Zurich - ZRH

      `;

      // ===== Parse rawAeroportos and populate origem/destino selects =====
      function parseRawAirports(raw) {
        if (!raw) return [];
        return raw
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter(Boolean)
          .map((line) => {
            // remove leading numbering like "12. " and stray bullets
            const noNum = line
              .replace(/^\s*\d+\.\s*/, "")
              .replace(/^[-\u2022\*]\s*/, "");
            // try to capture a trailing IATA code (2-4 uppercase letters) at the end
            const codeMatch = noNum.match(/([A-Z]{2,4})\s*$/);
            const code = codeMatch ? codeMatch[1] : "";
            // remove trailing "- CODE" or "- CODE" patterns if present
            const name = code
              ? noNum.replace(/[-‚Äì‚Äî]\s*([A-Z]{2,4})\s*$/, "").trim()
              : noNum;
            // normalize spacing
            const cleanName = name.replace(/\s{2,}/g, " ");
            const label = code ? `${cleanName} (${code})` : cleanName;
            return { code, name: cleanName, label };
          });
      }

      function buildAirportOptions() {
        const list = parseRawAirports(rawAeroportos || "");
        const selects = Array.from(
          document.querySelectorAll("select.aero-select")
        );

        function makeOptions(el) {
          // keep an empty placeholder option
          // preserve previous selection (if any) and restore after rebuild
          const prev = el.value;
          el.innerHTML = "";
          const empty = document.createElement("option");
          empty.value = "";
          empty.textContent = "";
          el.appendChild(empty);
          for (const item of list) {
            const opt = document.createElement("option");
            opt.value = item.label;
            opt.textContent = item.label;
            el.appendChild(opt);
          }
          // try to restore previous selection if it still matches an option
          if (prev) {
            // exact match first
            try {
              el.value = prev;
            } catch (e) {}
            if (!el.value) {
              // try to match by visible text or normalized contains
              const normalize = (s) =>
                (s || "")
                  .toString()
                  .normalize("NFD")
                  .replace(/[\u0300-\u036f]/g, "")
                  .replace(/[\-‚Äì‚Äî\/\\()\.\,\*]/g, " ")
                  .replace(/\s+/g, " ")
                  .trim()
                  .toLowerCase();
              const np = normalize(prev);
              for (const o of Array.from(el.options)) {
                const tv = (o.textContent || o.value || "").toString();
                if (tv === prev || normalize(tv) === np || normalize(tv).includes(np)) {
                  el.value = o.value;
                  break;
                }
              }
            }
            try { el.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
          }
        }

        for (const el of selects) makeOptions(el);
        // ensure selects gain helper handlers that allow quick code lookup
        try {
          attachAeroSelectHandlers();
        } catch (e) {
          // ignore
        }
      }

      // populate selects once DOM is ready (if not already done elsewhere)
      document.addEventListener("DOMContentLoaded", () => {
        buildAirportOptions();
        try { attachAeroSelectHandlers(); } catch (e) {}
      });

      // ===== Time input sanitization: accept either 4 digits (2359) or HH:MM =====
      function normalizeTimeToHHMM(v) {
        if (!v) return "";
        // accept '2359' or '23:59' or '23h59' but prefer 4 digits or with ':'
        const onlyDigits = v.replace(/\D/g, "");
        if (/^\d{4}$/.test(onlyDigits)) {
          const hh = onlyDigits.slice(0, 2);
          const mm = onlyDigits.slice(2, 4);
          const H = Number(hh),
            M = Number(mm);
          if (H > 23 || M > 59) return "";
          return `${hh}:${mm}`;
        }
        // try HH:MM
        const m = v.match(/^(\d{1,2})[:h](\d{2})$/);
        if (m) {
          const hh = m[1].padStart(2, "0");
          const mm = m[2];
          const H = Number(hh),
            M = Number(mm);
          if (H > 23 || M > 59) return "";
          return `${hh}:${mm}`;
        }
        return "";
      }

      // attach listeners to sanitize time inputs (existing and future via delegation)
      document.addEventListener("DOMContentLoaded", () => {
        // sanitize existing known ids
        const timeIds = [
          "ida_partida_hora",
          "ida_chegada_hora",
          "volta_partida_hora",
          "volta_chegada_hora",
        ];
        timeIds.forEach((id) => {
          const el = Byid(id);
          if (el) {
            el.addEventListener("input", () => {
              // allow only digits and ':'
              el.value = el.value.replace(/[^0-9:]/g, "");
            });
            el.addEventListener("blur", () => {
              const norm = normalizeTimeToHHMM(el.value);
              if (norm) el.value = norm; // keep as HH:MM
            });
          }
        });

        // delegation for dynamic .time-input fields inside conexoes
        document.body.addEventListener("input", (e) => {
          const t = e.target;
          if (t && t.classList && t.classList.contains("time-input")) {
            t.value = t.value.replace(/[^0-9:]/g, "");
          }
        });
        document.body.addEventListener(
          "blur",
          (e) => {
            const t = e.target;
            if (t && t.classList && t.classList.contains("time-input")) {
              const norm = normalizeTimeToHHMM(t.value);
              if (norm) t.value = norm;
            }
          },
          true
        );
      });

      // Auto-fill rules linking ida <-> volta
      document.addEventListener("DOMContentLoaded", () => {
        // delegate changes from any ida select (including conexoes)
        document.body.addEventListener("change", (e) => {
          const t = e.target;
          if (!t || t.tagName !== "SELECT") return;
          const id = (t.id || "").toString();
          // only handle ida partida/chegada selects
          if (!id.startsWith("ida_partida_aero") && !id.startsWith("ida_chegada_aero")) return;

          const tipo = Byid("tipo_viagem_select")?.value;
          if (tipo !== "ida/volta") return; // only for round trips

          const selectedText = (t.selectedOptions && t.selectedOptions[0] && t.selectedOptions[0].textContent) || t.value || "";
          // 1) if user set ida_partida -> fill volta_chegada (main or last connection) when empty
          if (id.startsWith("ida_partida_aero")) {
            const qVolta = Math.max(0, Number(Byid("volta_conexoes_count")?.value || 0));
            let target = null;
            if (qVolta > 0) {
              const last = qVolta - 1;
              target = Byid(`volta_chegada_aero_${last}`) || Byid("volta_chegada_aero");
            } else {
              target = Byid("volta_chegada_aero");
            }
            if (target && !target.value) {
              setSelectByLabel(target, selectedText);
            }
          }

          // 2) if user set ida_chegada -> fill volta_partida (main or last connection) when empty
          if (id.startsWith("ida_chegada_aero")) {
            const qVolta = Math.max(0, Number(Byid("volta_conexoes_count")?.value || 0));
            let target = null;
            if (qVolta > 0) {
              const last = qVolta - 1;
              target = Byid(`volta_partida_aero_${last}`) || Byid("volta_partida_aero");
            } else {
              target = Byid("volta_partida_aero");
            }
            if (target && !target.value) {
              setSelectByLabel(target, selectedText);
            }
          }
        });
      });
    </script>
  </body>
</html>
