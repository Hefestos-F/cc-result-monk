<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Declaração de Embarque</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:20px;max-width:900px;margin:auto;color:#111}
      label{display:block;margin-top:12px;font-weight:600}
      input, textarea, select{padding:8px;border:1px solid #ccc;border-radius:6px;margin-top:6px}
      .row{display:flex;gap:12px}
      .row > *{flex:1}
      .actions{margin-top:18px;display:flex;gap:8px}
      button{padding:8px 12px;border-radius:6px;border:0;background:#0366d6;color:white;cursor:pointer}
      button.ghost{background:#eee;color:#111}
      pre#preview{white-space:pre-wrap;background:#f7f9fc;border:1px solid #e1e4ea;padding:16px;border-radius:6px;margin-top:12px}
      .muted{color:#555;font-size:0.9rem}
    </style>
  </head>
  <body>
    <h1>Declaração de Embarque</h1>
    <p class="muted">
      Preencha os campos abaixo e clique em "Gerar Declaração" para criar o
      texto formatado.
    </p>
    <div class="row">
      <label for="cidade">Cidade da declaração</label>
      <input id="cidade" value="São Paulo" readonly />
      <label for="declaracao_date">Data da declaração</label>
      <input
        id="declaracao_date"
        type="date"
        aria-label="data da declaracao"
        readonly
      />

      <label for="companhia">Companhia aérea</label>
      <input id="companhia" value="GOL Linhas Aéreas S.A" readonly disabled />
    </div>
    <div class="row">
      <input id="OouA" placeholder="O ou A" />
      <label for="nome">Nome do(a) passageiro(a)</label>
      <input id="nome" placeholder="nome" />

      <label for="localizador">Código localizador</label>
      <input id="localizador" placeholder="ABCDEF" />
    </div>
    <div class="row">
      <label for="origem">Origem</label>
      <select id="origem">
        <option placeholder="Origem"></option>
        <option value="Belém (BEL)">Belém (BEL)</option>
        <option value="Belo Horizonte - Confins (CNF)">
          Belo Horizonte - Confins (CNF)
        </option>
        <option value="Brasília (BSB)">Brasília (BSB)</option>
        <option value="Curitiba (CWB)">Curitiba (CWB)</option>
        <option value="Florianópolis (FLN)">Florianópolis (FLN)</option>
        <option value="Fortaleza (FOR)">Fortaleza (FOR)</option>
        <option value="Manaus (MAO)">Manaus (MAO)</option>
        <option value="Porto Alegre (POA)">Porto Alegre (POA)</option>
        <option value="Recife (REC)">Recife (REC)</option>
        <option value="Rio de Janeiro - Galeão (GIG)">
          Rio de Janeiro - Galeão (GIG)
        </option>
        <option value="Rio de Janeiro - Santos Dumont (SDU)">
          Rio de Janeiro - Santos Dumont (SDU)
        </option>
        <option value="Salvador (SSA)">Salvador (SSA)</option>
        <option value="São Paulo - Congonhas (CGH)">
          São Paulo - Congonhas (CGH)
        </option>
        <option value="São Paulo - Guarulhos (GRU)">
          São Paulo - Guarulhos (GRU)
        </option>
      </select>

      <label for="destino">Destino</label>
      <select id="destino">
        <option placeholder="Origem"></option>
        <option value="Belém (BEL)">Belém (BEL)</option>
        <option value="Belo Horizonte - Confins (CNF)">
          Belo Horizonte - Confins (CNF)
        </option>
        <option value="Brasília (BSB)">Brasília (BSB)</option>
        <option value="Curitiba (CWB)">Curitiba (CWB)</option>
        <option value="Florianópolis (FLN)">Florianópolis (FLN)</option>
        <option value="Fortaleza (FOR)">Fortaleza (FOR)</option>
        <option value="Manaus (MAO)">Manaus (MAO)</option>
        <option value="Porto Alegre (POA)">Porto Alegre (POA)</option>
        <option value="Recife (REC)">Recife (REC)</option>
        <option value="Rio de Janeiro - Galeão (GIG)">
          Rio de Janeiro - Galeão (GIG)
        </option>
        <option value="Rio de Janeiro - Santos Dumont (SDU)">
          Rio de Janeiro - Santos Dumont (SDU)
        </option>
        <option value="Salvador (SSA)">Salvador (SSA)</option>
        <option value="São Paulo - Congonhas (CGH)">
          São Paulo - Congonhas (CGH)
        </option>
        <option value="São Paulo - Guarulhos (GRU)">
          São Paulo - Guarulhos (GRU)
        </option>
      </select>
    </div>
    <h3>Voo de ida</h3>
    <label>Tipo de viagem</label>
    <select id="tipo_viagem_select" onchange="marcadoida()">
      <option placeholder="tipo"></option>
      <option value="ida">IDA</option>
      <option value="ida/volta">IDA/VOLTA</option>
    </select>
    <div id="CaixaDida" style="display: none;">
      <div class="row">
        <div>
          <label for="ida_data">Data (ida)</label>
          <input id="ida_data" type="date" aria-label="data ida" required />
        </div>
        <div>
          <label for="ida_num">Número do voo</label>
          <input id="ida_num" placeholder="1234" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="ida_partida_aero">Partida</label>
          <input id="ida_partida_aero" placeholder="aeroporto (código)" />
        </div>
        <div>
          <label for="ida_partida_hora">Horário partida</label>
          <input id="ida_partida_hora" placeholder="23:59" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="ida_chegada_aero">Chegada</label>
          <input id="ida_chegada_aero" placeholder="aeroporto (código)" />
        </div>
        <div>
          <label for="ida_chegada_hora">Horário chegada</label>
          <input id="ida_chegada_hora" placeholder="23:59" />
        </div>
      </div>
      <label for="ida_conexoes_count">Número de conexões (ida)</label>
      <input id="ida_conexoes_count" type="number" min="0" value="0" />
      <div id="ida_conexoes_container"></div>
    </div>

    <div id="CaixaDvolta" style=" display: none;">
      <div id="volta_section">
        <h3>Voo de volta</h3>
        <label for="volta_conexoes_count">Número de conexões (volta)</label>
        <input id="volta_conexoes_count" type="number" min="0" value="0" />
        <div id="volta_conexoes_container"></div>
      </div>
      <div class="row">
        <div>
          <label for="volta_data">Data (volta)</label>
          <input id="volta_data" type="date" aria-label="data volta" required />
        </div>
        <div>
          <label for="volta_num">Número do voo</label>
          <input id="volta_num" placeholder="1234" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="volta_partida_aero">Partida</label>
          <input id="volta_partida_aero" placeholder="aeroporto (código)" />
        </div>
        <div>
          <label for="volta_partida_hora">Horário partida</label>
          <input id="volta_partida_hora" placeholder="23:59" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="volta_chegada_aero">Chegada</label>
          <input id="volta_chegada_aero" placeholder="aeroporto (código)" />
        </div>
        <div>
          <label for="volta_chegada_hora">Horário chegada</label>
          <input id="volta_chegada_hora" placeholder="23:59" />
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="btn_exemplo" class="ghost">Carregar exemplo</button>
      <button id="btn_gerar">Gerar Declaração</button>
      <button id="btn_copiar" class="ghost">Copiar</button>
      <button id="btn_imprimir" class="ghost">Imprimir</button>
      <button id="btn_baixar" class="ghost">Baixar .txt</button>
    </div>

    <pre id="preview"></pre>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const declaracaoDate = document.getElementById("declaracao_date");
        if (declaracaoDate) {
          declaracaoDate.value = new Date().toISOString().split("T")[0];
        }
      });

      const Byid = (id) => document.getElementById(id);

      // ---- Campos de contagem e containers de conexões ----
      const ida_conexoes_count = Byid("ida_conexoes_count");
      const ida_conexoes_container = Byid("ida_conexoes_container");

      const volta_conexoes_count = Byid("volta_conexoes_count");
      const volta_conexoes_container = Byid("volta_conexoes_container");

      // ---- Mostrar/ocultar se é ida e/ou volta ----
      function marcadoida() {
        const CaixaDida = Byid("CaixaDida");
        const CaixaDvolta = Byid("CaixaDvolta");
        const tipo_viagem_select = Byid("tipo_viagem_select");

        if (
          tipo_viagem_select.value === "ida/volta" ||
          tipo_viagem_select.value === "ida"
        ) {
          CaixaDida.style.display = "block";
        } else {
          CaixaDida.style.display = "none";
        }

        if (tipo_viagem_select.value === "ida/volta") {
          CaixaDvolta.style.display = "block";
        } else {
          CaixaDvolta.style.display = "none";
        }

        atualizarIda();
        atualizarVolta();
      }

      // ---- Funções de geração de inputs de conexão ----
      function inputConexao(trecho, idx) {
        // trecho: "ida" ou "volta"
        return `
      <fieldset class="conexao-bloco">
        <legend>Conexão ${idx + 1} (${trecho})</legend>
        <div class="row">
          <div>
            <label for="${trecho}_num_${idx}">Número do voo</label>
            <input id="${trecho}_num_${idx}" placeholder="1234" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="${trecho}_partida_aero_${idx}">Partida</label>
            <input id="${trecho}_partida_aero_${idx}" placeholder="aeroporto (código)" />
          </div>
          <div>
            <label for="${trecho}_partida_hora_${idx}">Horário partida</label>
            <input id="${trecho}_partida_hora_${idx}" placeholder="23:59" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="${trecho}_chegada_aero_${idx}">Chegada</label>
            <input id="${trecho}_chegada_aero_${idx}" placeholder="aeroporto (código)" />
          </div>
          <div>
            <label for="${trecho}_chegada_hora_${idx}">Horário chegada</label>
            <input id="${trecho}_chegada_hora_${idx}" placeholder="23:59" />
          </div>
        </div>
      </fieldset>
    `;
      }

      function renderConexoes(trecho, count) {
        const container =
          trecho === "ida" ? ida_conexoes_container : volta_conexoes_container;
        let html = "";
        for (let i = 0; i < count; i++) {
          html += inputConexao(trecho, i);
        }
        if (container) container.innerHTML = html;
      }

      // ---- Eventos para quantidade de conexões (IDA/ VOLTA) ----
      if (ida_conexoes_count) {
        ida_conexoes_count.addEventListener("input", () => {
          const qtd = Math.max(0, Number(ida_conexoes_count.value || 0));
          renderConexoes("ida", qtd);
          atualizarIda(); // reavalia preenchimento automático quando vira 0
        });
      }

      if (volta_conexoes_count) {
        volta_conexoes_count.addEventListener("input", () => {
          const qtd = Math.max(0, Number(volta_conexoes_count.value || 0));
          renderConexoes("volta", qtd);
          atualizarVolta(); // reavalia preenchimento automático quando vira 0
        });
      }

      // ---- Preenchimento automático do aeroporto (IDA e VOLTA) ----
      const ida_partida_aero = Byid("ida_partida_aero");
      const ida_chegada_aero = Byid("ida_chegada_aero");
      const volta_partida_aero = Byid("volta_partida_aero");
      const volta_chegada_aero = Byid("volta_chegada_aero");

      const origem = Byid("origem"); // deve existir no HTML
      const destino = Byid("destino"); // deve existir no HTML

      function atualizarIda() {
        if (ida_partida_aero && origem) {
          if (ida_partida_aero.value === "") {
            ida_partida_aero.value = origem.value;
          }
        }
        const con = Number(ida_conexoes_count?.value || 0);
        if (con === 0 && ida_chegada_aero && destino) {
          if (ida_chegada_aero.value === "") {
            ida_chegada_aero.value = destino.value;
          }
        }
      }

      function atualizarVolta() {
        // Volta parte do destino
        if (volta_partida_aero && destino) {
          if (volta_partida_aero.value === "") {
            volta_partida_aero.value = destino.value;
          }
        }
        // Se não existem conexões na volta, chegada é a origem
        const con = Number(volta_conexoes_count?.value || 0);
        if (con === 0 && volta_chegada_aero && origem) {
          if (volta_chegada_aero.value === "") {
            volta_chegada_aero.value = origem.value;
          }
        }
      }

      if (ida_partida_aero && ida_chegada_aero) {
        ida_partida_aero.addEventListener("input", atualizarIda);
        ida_chegada_aero.addEventListener("input", atualizarIda);
      }
      if (volta_partida_aero && volta_chegada_aero) {
        volta_partida_aero.addEventListener("input", atualizarVolta);
        volta_chegada_aero.addEventListener("input", atualizarVolta);
      }

      // ---- Texto inicial (cidade e data da declaração) ----
      function textoInicial() {
        const cidadeEl = Byid("cidade");
        const dataDeclEl = Byid("declaracao_date");
        const cidade = cidadeEl ? cidadeEl.value : "";
        const dataDecl = dataDeclEl ? dataDeclEl.value : "";
        return `${cidade}, ${dataDecl}`;
      }

      // ---- Botão "Gerar Declaração" ----
      const btnGerar = Byid("btn_gerar");
      const preview = Byid("preview");

      if (btnGerar && preview) {
        btnGerar.addEventListener("click", (e) => {
          e.preventDefault();
          const tipo = Byid("tipo_viagem_select")?.value;
          const partes = [textoInicial(), textodaida()];
          if (tipo === "ida/volta") partes.push(textodavolta());
          preview.innerHTML = partes.filter(Boolean).join(". ") + ".";
        });
      }

      // ---- Render inicial (garante estado consistente ao carregar) ----
      (function init() {
        const qIda = Math.max(0, Number(ida_conexoes_count?.value || 0));
        const qVolta = Math.max(0, Number(volta_conexoes_count?.value || 0));
        renderConexoes("ida", qIda);
        renderConexoes("volta", qVolta);
        atualizarIda();
        atualizarVolta();
      })();
      // ===== Utilitários de formatação/validação =====

      // 1) Localizador: 6 caracteres maiúsculos (alfa-numérico)
      function normalizeLocalizador(v) {
        if (!v) return "";
        return v
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "")
          .slice(0, 6);
      }
      function isValidLocalizador(v) {
        return /^[A-Z0-9]{6}$/.test(v);
      }

      // 2) Nome: primeira letra maiúscula e restante minúsculo
      function formatPassengerName(v) {
        if (!v) return "";
        v = v.trim();
        return v.charAt(0).toUpperCase() + v.slice(1).toLowerCase();
      }

      // 3) Data: "01 de Janeiro de 2025"
      function formatDateLong(yyyy_mm_dd) {
        if (!yyyy_mm_dd) return "";
        const [y, m, d] = yyyy_mm_dd.split("-").map(Number);
        if (!y || !m || !d) return "";
        const meses = [
          "Janeiro",
          "Fevereiro",
          "Março",
          "Abril",
          "Maio",
          "Junho",
          "Julho",
          "Agosto",
          "Setembro",
          "Outubro",
          "Novembro",
          "Dezembro",
        ];
        const dd = String(d).padStart(2, "0");
        const mes = meses[m - 1] || "";
        return `${dd} de ${mes} de ${y}`;
      }

      // 4) Número do voo: sempre 4 dígitos
      function onlyDigits(v) {
        return (v || "").replace(/\D/g, "");
      }
      function fourDigitFlight(v) {
        // Mantém só dígitos e força 4 dígitos (com zero à esquerda, se necessário)
        const d = onlyDigits(v).slice(0, 4);
        return d.padStart(4, "0");
      }
      function isValidFourDigit(v) {
        return /^\d{4}$/.test(v);
      }

      // 5) Horário: "23h59" (aceita "23:59" no input e formata na saída)
      function normalizeTimeToHHMM(v) {
        if (!v) return "";
        // aceita "23:59", "2359", "23h59"
        const digits = v.replace(/\D/g, "").slice(0, 4); // hhmm
        if (digits.length < 4) return "";
        const hh = digits.slice(0, 2);
        const mm = digits.slice(2, 4);
        // valida faixa simples
        const H = Number(hh),
          M = Number(mm);
        if (H > 23 || M > 59) return "";
        return `${hh}:${mm}`;
      }
      function formatTimeHhMm(v) {
        // recebe "23:59" e devolve "23h59"
        if (!v) return "";
        const norm = normalizeTimeToHHMM(v);
        if (!norm) return "";
        const [hh, mm] = norm.split(":");
        return `${hh}h${mm}`;
      }

      // ===== Listeners para higienizar enquanto digita =====
      document.addEventListener("DOMContentLoaded", () => {
        // a) Localizador
        const localizador = Byid("localizador");
        if (localizador) {
          localizador.addEventListener("input", () => {
            const cur = localizador.selectionStart; // tenta preservar caret
            const val = normalizeLocalizador(localizador.value);
            localizador.value = val;
            // reposiciona caret ao fim
            localizador.setSelectionRange(val.length, val.length);
          });
        }

        // b) Nome do passageiro
        const nome = Byid("nome");
        if (nome) {
          nome.addEventListener("blur", () => {
            nome.value = formatPassengerName(nome.value);
          });
        }

        // c) Números de voo fixos (ida e volta)
        const ida_num = Byid("ida_num");
        if (ida_num) {
          ida_num.addEventListener("input", () => {
            ida_num.value = onlyDigits(ida_num.value).slice(0, 4);
          });
        }
        const volta_num = Byid("volta_num");
        if (volta_num) {
          volta_num.addEventListener("input", () => {
            volta_num.value = onlyDigits(volta_num.value).slice(0, 4);
          });
        }

        // d) Números de voo das conexões (delegado para ida/volta)
        const ida_conexoes_container = Byid("ida_conexoes_container");
        if (ida_conexoes_container) {
          ida_conexoes_container.addEventListener("input", (e) => {
            const el = e.target;
            if (el && /^ida_num_\d+$/.test(el.id)) {
              el.value = onlyDigits(el.value).slice(0, 4);
            }
          });
        }
        const volta_conexoes_container = Byid("volta_conexoes_container");
        if (volta_conexoes_container) {
          volta_conexoes_container.addEventListener("input", (e) => {
            const el = e.target;
            if (el && /^volta_num_\d+$/.test(el.id)) {
              el.value = onlyDigits(el.value).slice(0, 4);
            }
          });
        }

        // e) Opcional: se usar <input type="time">, não precisa de máscara; se usar texto, pode normalizar no blur
        const horaIds = [
          "ida_partida_hora",
          "ida_chegada_hora",
          "volta_partida_hora",
          "volta_chegada_hora",
        ];
        horaIds.forEach((id) => {
          const el = Byid(id);
          if (el) {
            el.addEventListener("blur", () => {
              // Aceita o que o usuário escreveu e converte internamente para HH:MM válido
              const norm = normalizeTimeToHHMM(el.value);
              if (norm) el.value = norm; // mantém como "HH:MM" no input
            });
          }
        });

        // f) Preencher data da declaração com hoje (mantendo type="date")
        const declaracaoDate = Byid("declaracao_date");
        if (declaracaoDate && !declaracaoDate.value) {
          declaracaoDate.value = new Date().toISOString().split("T")[0];
        }
      });

      // ===== Validação antes de gerar =====
      function validateRules() {
        const errors = [];

        const loc = Byid("localizador")?.value || "";
        if (!isValidLocalizador(loc)) {
          errors.push(
            "Código localizador deve ter 6 caracteres alfa-numéricos em MAIÚSCULO (ex.: ABC123)."
          );
        }

        const idaNum = Byid("ida_num")?.value || "";
        if (!isValidFourDigit(onlyDigits(idaNum).padStart(4, "0"))) {
          errors.push("Número do voo (ida) deve conter 4 dígitos (ex.: 0123).");
        }

        const voltaNumEl = Byid("volta_num");
        if (voltaNumEl && Byid("tipo_viagem_select")?.value === "ida/volta") {
          const v = voltaNumEl.value || "";
          if (!isValidFourDigit(onlyDigits(v).padStart(4, "0"))) {
            errors.push(
              "Número do voo (volta) deve conter 4 dígitos (ex.: 0456)."
            );
          }
        }

        // Conexões IDA
        const qIda = Number(Byid("ida_conexoes_count")?.value || 0);
        for (let i = 0; i < qIda; i++) {
          const v = Byid(`ida_num_${i}`)?.value || "";
          if (!isValidFourDigit(onlyDigits(v).padStart(4, "0"))) {
            errors.push(
              `Número do voo da conexão ${i + 1} (ida) deve conter 4 dígitos.`
            );
          }
        }

        // Conexões VOLTA
        const qVolta = Number(Byid("volta_conexoes_count")?.value || 0);
        const tipo = Byid("tipo_viagem_select")?.value;
        if (tipo === "ida/volta") {
          for (let i = 0; i < qVolta; i++) {
            const v = Byid(`volta_num_${i}`)?.value || "";
            if (!isValidFourDigit(onlyDigits(v).padStart(4, "0"))) {
              errors.push(
                `Número do voo da conexão ${
                  i + 1
                } (volta) deve conter 4 dígitos.`
              );
            }
          }
        }

        // Horários: aceitar HH:MM no input, mas precisam ser válidos
        const timeIds = ["ida_partida_hora", "ida_chegada_hora"];
        if (tipo === "ida/volta")
          timeIds.push("volta_partida_hora", "volta_chegada_hora");
        for (const id of timeIds) {
          const el = Byid(id);
          if (el) {
            const norm = normalizeTimeToHHMM(el.value);
            if (!norm)
              errors.push(
                `Horário inválido em "${id}". Use formato HH:MM (ex.: 23:59).`
              );
          }
        }

        return errors;
      }

      // ===== Ajuste nas funções de geração de texto =====
      function textoInicial() {
        const cidade = Byid("cidade")?.value || "";
        const dataDeclRaw = Byid("declaracao_date")?.value || "";
        const dataDeclFmt = formatDateLong(dataDeclRaw);
        return `${cidade}, ${dataDeclFmt}`;
      }

      function textodaida() {
        // Normalizações exigidas
        const nomeFmt = formatPassengerName(Byid("nome")?.value || "");
        const OouA = Byid("OouA");
        const OouAV = OouA.value || "a";
        const localizadorFmt = normalizeLocalizador(
          Byid("localizador")?.value || ""
        );
        const companhia = Byid("companhia")?.value || "GOL Linhas Aéreas S.A";

        const ida_data_raw = Byid("ida_data")?.value || "";
        const ida_data_fmt = formatDateLong(ida_data_raw);

        const ida_num_fmt = fourDigitFlight(Byid("ida_num")?.value || "");
        const ida_partida_aero_v = Byid("ida_partida_aero")?.value || "";
        const ida_partida_hora_fmt = formatTimeHhMm(
          Byid("ida_partida_hora")?.value || ""
        );
        const ida_chegada_aero_v = Byid("ida_chegada_aero")?.value || "";
        const ida_chegada_hora_fmt = formatTimeHhMm(
          Byid("ida_chegada_hora")?.value || ""
        );

        let texto =
          `Fazemos referência, por ora, que&nbsp;${OouA}&nbsp;Sr.(a)&nbsp;${nomeFmt}&nbsp;possuía a passagem de código ` +
          `localizador ${localizadorFmt} e embarcou com a companhia ${companhia}, sendo o voo de ` +
          `ida no dia&nbsp;${ida_data_fmt}, no voo G3&nbsp;${ida_num_fmt}, partindo do ${ida_partida_aero_v} às ${ida_partida_hora_fmt}, ` +
          `chegando em ${ida_chegada_aero_v} às ${ida_chegada_hora_fmt}`;

        const qtdCon = Number(Byid("ida_conexoes_count")?.value || 0);
        for (let i = 0; i < qtdCon; i++) {
          const v = fourDigitFlight(Byid(`ida_num_${i}`)?.value || "");
          const o = Byid(`ida_partida_aero_${i}`)?.value || "";
          const hs = formatTimeHhMm(Byid(`ida_partida_hora_${i}`)?.value || "");
          const d = Byid(`ida_chegada_aero_${i}`)?.value || "";
          const hc = formatTimeHhMm(Byid(`ida_chegada_hora_${i}`)?.value || "");
          texto += `; com conexão no voo G3&nbsp;${v}, partindo de ${o} às&nbsp;${hs},&nbsp;chegando em ${d} às&nbsp;${hc}`;
        }

        return texto;
      }

      function textodavolta() {
        const volta_data_fmt = formatDateLong(Byid("volta_data")?.value || "");
        const volta_num_fmt = fourDigitFlight(Byid("volta_num")?.value || "");
        const volta_partida_aero_v = Byid("volta_partida_aero")?.value || "";
        const volta_partida_hora_fmt = formatTimeHhMm(
          Byid("volta_partida_hora")?.value || ""
        );
        const volta_chegada_aero_v = Byid("volta_chegada_aero")?.value || "";
        const volta_chegada_hora_fmt = formatTimeHhMm(
          Byid("volta_chegada_hora")?.value || ""
        );

        let texto =
          `E&nbsp;o voo de&nbsp;volta&nbsp;no dia&nbsp;${volta_data_fmt}, no voo G3&nbsp;${volta_num_fmt}, partindo de&nbsp;${volta_partida_aero_v} às ` +
          `${volta_partida_hora_fmt}, chegando em ${volta_chegada_aero_v} às ${volta_chegada_hora_fmt}`;

        const qtdCon = Number(Byid("volta_conexoes_count")?.value || 0);
        for (let i = 0; i < qtdCon; i++) {
          const v = fourDigitFlight(Byid(`volta_num_${i}`)?.value || "");
          const o = Byid(`volta_partida_aero_${i}`)?.value || "";
          const hs = formatTimeHhMm(
            Byid(`volta_partida_hora_${i}`)?.value || ""
          );
          const d = Byid(`volta_chegada_aero_${i}`)?.value || "";
          const hc = formatTimeHhMm(
            Byid(`volta_chegada_hora_${i}`)?.value || ""
          );
          texto += `; com conexão no voo G3&nbsp;${v}, partindo de ${o} às&nbsp;${hs},&nbsp;chegando em ${d} às&nbsp;${hc}`;
        }

        return texto;
      }

      // ===== Integre com seu botão "Gerar Declaração" =====
      document.addEventListener("DOMContentLoaded", () => {
        const btnGerar = Byid("btn_gerar");
        const preview = Byid("preview");
        if (btnGerar && preview) {
          btnGerar.addEventListener("click", (e) => {
            e.preventDefault();
            const errs = validateRules();
            if (errs.length) {
              preview.innerHTML = `<strong>Corrija os seguintes itens:</strong><br>- ${errs.join(
                "<br>- "
              )}`;
              return;
            }
            const tipo = Byid("tipo_viagem_select")?.value;
            const partes = [textoInicial(), textodaida()];
            if (tipo === "ida/volta") partes.push(textodavolta());
            preview.innerHTML = partes.filter(Boolean).join(". ") + ".";
          });
        }
      });
    </script>
  </body>
</html>
