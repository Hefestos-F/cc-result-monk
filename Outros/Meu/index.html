<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Monitor Exaustor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial;
        background: #121212;
        color: #fff;
        text-align: center;
        margin: 0;
        padding: 0;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #1e1e1e;
      }

      .btn {
        padding: 5px 10px;
        background: #4caf50;
        border: none;
        border-radius: 5px;
        color: white;
        cursor: pointer;
        height: auto;
        width: auto;
      }

      .btn:hover {
        background: #45a049;
      }

      .card {
        background: #1e1e1e;
        padding: 20px;
        margin: 20px auto;
        width: 90%;
        max-width: 500px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
      }

      .chart-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
      }

      .chart-box {
        flex: 1 1 300px;
        margin: 10px;
        background: #2c2c2c;
        padding: 10px;
        border-radius: 10px;
      }

      .config-panel {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        padding-top: 50px;
        overflow: auto;
      }

      .config-content {
        background: #1e1e1e;
        margin: auto;
        padding: 20px;
        width: 90%;
        max-width: 350px;
        border-radius: 10px;
      }

      input,
      button,
      label {
        width: 90%;
        padding: 10px;
        margin: 8px 0;
        border: none;
        border-radius: 5px;
      }

      input[type="text"],
      input[type="password"],
      input[type="number"] {
        background: #2c2c2c;
        color: #fff;
      }

      .tab {
        cursor: pointer;
        padding: 10px;
        display: inline-block;
        background: #2c2c2c;
        margin-right: 2px;
        border-radius: 5px;
      }

      .tab.active {
        background: #4caf50;
      }

      .tab-content {
        display: none;
        margin-top: 10px;
      }

      .tab-content.active {
        display: block;
      }

      .alert {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h2>Exaustor Monitor</h2>
      <button class="btn" onclick="toggleConfig()">⚙️ Config</button>
    </div>

    <div class="card">
      <h3>Status LED</h3>
      <p id="led">--</p>
      <button class="btn" onclick="toggleLED()">Alternar LED</button>
    </div>

    <div class="card">
      <h3>Alertas</h3>
      <p id="tempAlert" class="alert">--</p>
      <p id="fanAlert" class="alert">--</p>
    </div>

    <div class="chart-container">
      <div class="chart-box"><canvas id="tempChart" height="150"></canvas></div>
      <div class="chart-box"><canvas id="humChart" height="150"></canvas></div>
      <div class="chart-box"><canvas id="fanChart" height="150"></canvas></div>
    </div>

    <div id="config" class="config-panel">
      <div class="config-content">
        <div>
          <span class="tab active" onclick="showTab('wifi')">WiFi</span>
          <span class="tab" onclick="showTab('notificacoes')"
            >Notificações</span
          >
        </div>

        <div id="wifi" class="tab-content active">
          <h3>Configuração AP</h3>
          <input id="ap_ssid" type="text" placeholder="SSID AP" />
          <input id="ap_pass" type="password" placeholder="Senha AP" />
          <button onclick="saveAP()">Salvar AP</button>
          <hr />
          <h3>Configuração Cliente</h3>
          <input id="sta_ssid" type="text" placeholder="SSID WiFi" />
          <input id="sta_pass" type="password" placeholder="Senha WiFi" />
          <input
            id="sta_site"
            type="text"
            placeholder="Site (ex: meusite.casa)"
          />
          <button onclick="saveSTA()">Salvar STA</button>
        </div>

        <div id="notificacoes" class="tab-content">
          <h3>Notificações</h3>
          <label
            ><input type="checkbox" id="tempNotif" /> Ativar notificação de
            temperatura</label
          >
          <input
            id="tempLimite"
            type="number"
            placeholder="Temperatura limite (°C)"
          />
          <label><input type="checkbox" id="tempBip" /> Bip</label>
          <label><input type="checkbox" id="tempLed" /> LED</label>
          <hr />
          <label
            ><input type="checkbox" id="fanNotif" /> Notificar exaustor
            parado</label
          >
          <label><input type="checkbox" id="fanBip" /> Bip</label>
          <label><input type="checkbox" id="fanLed" /> LED</label>
          <button onclick="saveNotif()">Salvar Notificações</button>
        </div>

        <hr />
        <button onclick="toggleConfig()">Fechar</button>
      </div>
    </div>

    <script>
      var ws = new WebSocket("ws://" + location.hostname + ":81/");
      var tempData = [],
        humData = [],
        fanData = [],
        labels = [];
      var maxPoints = 30;

      var ctxTemp = document.getElementById("tempChart").getContext("2d");
      var tempChart = new Chart(ctxTemp, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Temperatura (°C)",
              data: tempData,
              borderColor: "red",
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          animation: false,
          scales: { y: { beginAtZero: true } },
        },
      });
      var ctxHum = document.getElementById("humChart").getContext("2d");
      var humChart = new Chart(ctxHum, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Umidade (%)",
              data: humData,
              borderColor: "blue",
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          animation: false,
          scales: { y: { beginAtZero: true, max: 100 } },
        },
      });
      var ctxFan = document.getElementById("fanChart").getContext("2d");
      var fanChart = new Chart(ctxFan, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Velocidade (RPM)",
              data: fanData,
              borderColor: "green",
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          animation: false,
          scales: { y: { beginAtZero: true } },
        },
      });

      ws.onopen = () => console.log("WebSocket conectado");
      ws.onmessage = (evt) => {
        try {
          let data = JSON.parse(evt.data);
          document.getElementById("led").innerText = data.led || "--";

          // Alertas
          document.getElementById("tempAlert").innerText = data.tempAlert
            ? "⚠️ Temperatura alta!"
            : "";
          document.getElementById("fanAlert").innerText = data.fanAlert
            ? "⚠️ Exaustor parado!"
            : "";

          let now = new Date().toLocaleTimeString();
          labels.push(now);
          if (labels.length > maxPoints) {
            labels.shift();
            tempData.shift();
            humData.shift();
            fanData.shift();
          }

          if (data.temp !== undefined) tempData.push(data.temp);
          if (data.hum !== undefined) humData.push(data.hum);
          if (data.fan !== undefined) fanData.push(data.fan);

          tempChart.update();
          humChart.update();
          fanChart.update();
        } catch (e) {
          console.log("Erro JSON:", evt.data);
        }
      };
      ws.onclose = () => {
        console.log("WebSocket desconectado");
        setTimeout(() => location.reload(), 2000);
      };

      function toggleConfig() {
        document.getElementById("config").style.display =
          document.getElementById("config").style.display === "block"
            ? "none"
            : "block";
      }
      function showTab(tab) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab")
          .forEach((tb) => tb.classList.remove("active"));
        document.getElementById(tab).classList.add("active");
        event.target.classList.add("active");
      }
      function saveAP() {
        ws.send(
          JSON.stringify({
            type: "ap",
            ssid: document.getElementById("ap_ssid").value,
            pass: document.getElementById("ap_pass").value,
          })
        );
      }
      function saveSTA() {
        ws.send(
          JSON.stringify({
            type: "sta",
            ssid: document.getElementById("sta_ssid").value,
            pass: document.getElementById("sta_pass").value,
            site: document.getElementById("sta_site").value,
          })
        );
      }
      function toggleLED() {
        ws.send(JSON.stringify({ type: "led" }));
      }
      function saveNotif() {
        ws.send(
          JSON.stringify({
            type: "notif",
            tempNotif: document.getElementById("tempNotif").checked,
            tempLimite: Number(document.getElementById("tempLimite").value),
            tempBip: document.getElementById("tempBip").checked,
            tempLed: document.getElementById("tempLed").checked,
            fanNotif: document.getElementById("fanNotif").checked,
            fanBip: document.getElementById("fanBip").checked,
            fanLed: document.getElementById("fanLed").checked,
          })
        );
        alert("Configurações de notificação enviadas!");
      }
    </script>
  </body>
</html>