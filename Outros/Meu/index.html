<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Exaustor Monitor</title>

  <style>
    :root[data-theme="dark"]{
      --bg:#121212; --surface:#1a1a1a; --surface-2:#232323; --text:#ffffff; --muted:#bdbdbd;
      --primary:#4caf50; --primary-hover:#45a049; --danger:#ff6b6b; --warn:#ffb300; --info:#42a5f5;
      --tick:#9aa2a8; --grid:rgba(255,255,255,.08);
      --shadow:0 6px 18px rgba(0,0,0,.35);
      --ch-temp:#ff6b6b; --ch-hum:#42a5f5; --ch-rpm:#66bb6a;
    }
    :root[data-theme="light"]{
      --bg:#f5f5f7; --surface:#ffffff; --surface-2:#f2f3f5; --text:#101214; --muted:#5f6b73;
      --primary:#2e7d32; --primary-hover:#256428; --danger:#d32f2f; --warn:#ed6c02; --info:#1565c0;
      --tick:#6c7780; --grid:rgba(0,0,0,.08);
      --shadow:0 8px 20px rgba(0,0,0,.08);
      --ch-temp:#e53935; --ch-hum:#1e88e5; --ch-rpm:#43a047;
    }

    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 20px; background:var(--surface); box-shadow:var(--shadow); position:sticky; top:0; z-index:10;
    }
    h1{ margin:0; font-size:1.15rem; letter-spacing:.2px }
    .btn{
      padding:8px 14px; border:none; border-radius:10px; background:var(--primary);
      color:#fff; cursor:pointer; font-weight:700; transition:transform .06s ease, background .2s ease;
    }
    .btn:hover{ background:var(--primary-hover) }
    .btn:active{ transform:translateY(1px) }
    .btn--ghost{ background:transparent; border:1px solid var(--surface-2); color:var(--text) }
    .btn--warn{ background:var(--warn); color:#fff }
    main{ padding:20px; max-width:1100px; margin:auto }

    /* Cards */
    .cards{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); margin-bottom:20px }
    .card{
      background:var(--surface); padding:16px; border-radius:14px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:10px;
    }
    .muted{ color:var(--muted) }
    .kpi{ font-size:1.8rem; font-weight:800; letter-spacing:.5px }

    /* Charts */
    .chart-grid{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)) }
    .chart-box{ background:var(--surface-2); padding:14px; border-radius:12px; height:270px; box-shadow:var(--shadow) }

    /* Modal (Config) */
    #configPanel{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:50; }
    #configPanel .wrap{ min-height:100%; display:grid; place-items:center; padding:20px }
    #configPanel .box{
      background:var(--surface); width:min(96vw,920px); max-height:90vh; overflow:auto;
      padding:18px; border-radius:16px; box-shadow:var(--shadow)
    }
    .cfg-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px }
    .tabs{ display:flex; gap:8px; border-bottom:1px solid #0003; padding-bottom:8px; margin-bottom:12px; flex-wrap:wrap }
    .tab{ padding:8px 12px; border-radius:10px; background:var(--surface-2); cursor:pointer; border:1px solid transparent }
    .tab.active{ background:var(--primary); color:#fff }
    .tab-pane{ display:none }
    .tab-pane.active{ display:block }
    .subtabs{ display:flex; gap:6px; margin:6px 0 10px }
    .subtab{ padding:6px 10px; border-radius:8px; background:var(--surface-2); cursor:pointer }
    .subtab.active{ background:var(--primary); color:#fff }

    fieldset{ border:1px solid #0003; border-radius:12px; padding:12px; margin:12px 0 }
    legend{ padding:0 8px; font-weight:700 }
    label{ display:block; margin:6px 0 4px; font-size:.93rem }
    input[type=text], input[type=password], input[type=number]{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #0003; background:var(--surface-2); color:var(--text)
    }
    input[type=range]{ width:100% }
    .row-2{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
    .row-3{ display:grid; gap:10px; grid-template-columns:repeat(3,1fr) }
    .row-4{ display:grid; gap:10px; grid-template-columns:repeat(4,1fr) }
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px }

    /* Toasts */
    .toasts{ position:fixed; right:16px; bottom:16px; z-index:1000; display:grid; gap:10px; width:min(90vw,380px) }
    .toast{
      display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:start;
      background:var(--surface); color:var(--text); border-left:5px solid var(--info);
      padding:10px 12px; border-radius:12px; box-shadow:var(--shadow);
      animation:slideIn .25s ease, fadeOut .3s ease var(--toast-timeout,3.5s) forwards;
    }
    .toast.warn{ border-color:var(--warn) } .toast.error{ border-color:var(--danger) } .toast.success{ border-color:var(--primary) }
    .toast .title{ font-weight:800 } .toast .msg{ opacity:.95 }
    .toast .close{ background:transparent; border:none; color:inherit; font-size:20px; cursor:pointer }
    .toast .bar{ grid-column:1/-1; height:3px; border-radius:0 0 12px 12px; background:linear-gradient(90deg,currentColor,transparent); opacity:.3; animation:barShrink linear var(--toast-timeout,3.5s) forwards }
    @keyframes slideIn{ from{ transform:translateY(10px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
    @keyframes fadeOut{ to{ opacity:0; transform:translateY(6px); height:0; margin:0; padding-top:0; padding-bottom:0 } }
    @keyframes barShrink{ from{ width:100% } to{ width:0% } }
  </style>
</head>
<body>
  <header>
    <h1>🌀 Exaustor Monitor</h1>
    <div style="display:flex; gap:8px;">
      <button class="btn" id="btnTheme">Tema: Sistema</button>
      <button class="btn" id="btnConfig">Config</button>
    </div>
  </header>

  <main>
    <section class="cards">
      <!-- LED removido da Home -->
      <div class="card">
        <h2>Duty PWM</h2>
        <div class="kpi"><span id="dutyVal">50</span>%</div>
        <span class="muted">Controlado nas abas Ventilação/Teste.</span>
      </div>

      <div class="card">
        <h2>Alertas</h2>
        <p id="tempAlert" class="alert">—</p>
        <p id="fanAlert" class="alert">—</p>
        <span class="muted">Toasts aparecem no canto inferior direito.</span>
      </div>
    </section>

    <section class="chart-grid">
      <div class="chart-box"><canvas id="tempChart"></canvas></div>
      <div class="chart-box"><canvas id="humChart"></canvas></div>
      <div class="chart-box"><canvas id="fanChart"></canvas></div>
    </section>
  </main>

  <!-- Configurações -->
  <div id="configPanel" role="dialog" aria-modal="true" aria-labelledby="cfgTitle">
    <div class="wrap">
      <div class="box">
        <div class="cfg-head">
          <h3 id="cfgTitle" style="margin:0;">Configurações</h3>
          <div style="display:flex; gap:8px;">
            <button class="btn btn--warn" id="btnReset">Restaurar padrão</button>
            <button class="btn btn--ghost" id="closeConfig">Fechar</button>
          </div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="internet">Internet</button>
          <button class="tab" data-tab="notificacoes">Notificações</button>
          <button class="tab" data-tab="ventilacao">Ventilação</button>
          <button class="tab" data-tab="teste">Teste</button>
        </div>

        <!-- Internet -->
        <div class="tab-pane active" id="pane-internet">
          <div class="subtabs">
            <button class="subtab active" data-subtab="ap">Modo AP</button>
            <button class="subtab" data-subtab="sta">Modo Cliente</button>
          </div>

          <div id="subpane-ap">
            <fieldset>
              <legend>Ponto de Acesso (AP)</legend>
              <label>SSID</label><input id="ap_ssid" type="text" placeholder="EXAUSTOR_AP" />
              <label>Senha</label><input id="ap_pass" type="password" placeholder="8–63 caracteres" />
              <div class="actions">
                <button class="btn" id="saveAP">Salvar AP</button>
              </div>
            </fieldset>
          </div>

          <div id="subpane-sta" style="display:none;">
            <fieldset>
              <legend>Cliente Wi‑Fi</legend>
              <label>SSID</label><input id="sta_ssid" type="text" placeholder="Nome da rede" />
              <label>Senha</label><input id="sta_pass" type="password" placeholder="8–63 caracteres" />
              <div class="actions">
                <button class="btn" id="saveSTA">Salvar Cliente</button>
              </div>
            </fieldset>
          </div>
        </div>

        <!-- Notificações -->
        <div class="tab-pane" id="pane-notificacoes">
          <fieldset>
            <legend>Temperatura</legend>
            <div class="row-3">
              <label><input type="checkbox" id="tempEnabled" /> Ativar</label>
              <label><input type="checkbox" id="tempBip" /> Bip</label>
              <label><input type="checkbox" id="tempLed" /> LED</label>
            </div>
            <div class="row-2">
              <div><label>Mín. (°C)</label><input id="tempMin" type="number" value="15" step="0.5" /></div>
              <div><label>Máx. (°C)</label><input id="tempMax" type="number" value="60" step="0.5" /></div>
            </div>
          </fieldset>

          <fieldset>
            <legend>Exaustor (RPM)</legend>
            <div class="row-3">
              <label><input type="checkbox" id="fanEnabled" /> Ativar</label>
              <label><input type="checkbox" id="fanBip" /> Bip</label>
              <label><input type="checkbox" id="fanLed" /> LED</label>
            </div>
            <div class="row-2">
              <div><label>Mín. (RPM)</label><input id="fanMin" type="number" value="300" step="10" /></div>
              <div><label>Máx. (RPM)</label><input id="fanMax" type="number" value="4000" step="10" /></div>
            </div>
            <span class="muted">Quando ativo, a faixa min–máx aparece como banda no gráfico de RPM.</span>
          </fieldset>

          <fieldset>
            <legend>Telegram (Somente visual)</legend>
            <p class="muted" style="margin-top:0">Aparência apenas — envio desativado nesta versão.</p>
            <div class="row-2">
              <div><label>Bot Token</label><input type="text" placeholder="123456:ABC..." disabled /></div>
              <div><label>Chat ID</label><input type="text" placeholder="123456789" disabled /></div>
            </div>
          </fieldset>
        </div>

        <!-- Ventilação -->
        <div class="tab-pane" id="pane-ventilacao">
          <fieldset>
            <legend>Controle do Cooler</legend>
            <label>Duty (%)</label>
            <input type="range" id="duty" min="0" max="100" value="50" />
            <div class="muted">Valor atual: <b><span id="dutyValCfg">50</span>%</b></div>
          </fieldset>

          <fieldset>
            <legend>Tema</legend>
            <div class="row-3">
              <label><input type="radio" name="theme" value="auto"  id="th_auto"> Sistema</label>
              <label><input type="radio" name="theme" value="dark"  id="th_dark"> Escuro</label>
              <label><input type="radio" name="theme" value="light" id="th_light"> Claro</label>
            </div>
            <span class="muted">O botão do cabeçalho alterna: <b>Auto → Escuro → Claro</b>.</span>
          </fieldset>
        </div>

        <!-- Teste -->
        <div class="tab-pane" id="pane-teste">
          <fieldset>
            <legend>Ações rápidas</legend>
            <div class="row-4">
              <button class="btn" id="btnBeep">Bipar</button>
              <button class="btn" id="btnLedOn">Acender LED</button>
              <button class="btn" id="btnLedOff">Apagar LED</button>
              <button class="btn" id="btnLedBlink">Piscar LED</button>
            </div>
            <div class="muted" style="margin-top:6px;">Status do LED: <b id="ledStatusTest">DESLIGADO</b></div>

            <div class="row-2" style="margin-top:10px;">
              <div>
                <label>Mensagem (toast)</label>
                <input type="text" id="testMsg" placeholder="Digite uma mensagem de teste..." />
              </div>
              <div class="actions" style="align-items:end; margin:0;">
                <button class="btn" id="btnSendMsg">Enviar mensagem</button>
              </div>
            </div>
          </fieldset>

          <fieldset>
            <legend>Controle do Exaustor</legend>
            <div class="row-4">
              <button class="btn" id="btnFanOn">Ligar</button>
              <button class="btn" id="btnFanOff">Desligar</button>
              <button class="btn" id="btnFanMin">0%</button>
              <button class="btn" id="btnFanMax">100%</button>
            </div>
            <label style="margin-top:8px;">Velocidade (Duty %)</label>
            <input type="range" id="testDuty" min="0" max="100" value="50" />
            <div class="muted">Duty: <b><span id="testDutyVal">50</span>%</b> • RPM estimado: <b><span id="testRpmVal">0</span></b></div>
          </fieldset>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    // ========= Estado + Persistência =========
    const LS_KEY = 'exaustor_moderno_v1';
    const defaults = {
      theme:'auto',       // 'auto' | 'dark' | 'light'
      ledOn:false,
      duty:50,
      fanOn:true,
      wifi:{ ap:{ssid:'EXAUSTOR_AP', pass:''}, sta:{ssid:'', pass:''} },
      notif:{
        temp:{enabled:false, min:15, max:60, bip:false, led:false},
        fan:{enabled:false, min:300, max:4000, bip:false, led:false}
      }
    };
    const state = load() || structuredClone(defaults);
    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch{ return null; } }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    // ========= Helpers/UI =========
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const root = document.documentElement;
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)');

    function resolveTheme(){ return state.theme==='auto' ? (prefersDark?.matches ? 'dark' : 'light') : state.theme; }
    function applyTheme(){
      const resolved = resolveTheme();
      root.dataset.theme = resolved;
      $('#btnTheme').textContent = 'Tema: ' + (state.theme==='auto'?'Sistema':(resolved==='dark'?'Escuro':'Claro'));
      $('#th_auto').checked = state.theme==='auto';
      $('#th_dark').checked = state.theme==='dark';
      $('#th_light').checked = state.theme==='light';
      // atualiza aparência dos gráficos
      refreshChartTheme();
    }
    prefersDark?.addEventListener?.('change', ()=>{ if(state.theme==='auto') applyTheme(); });

    // ========= Toasts =========
    const toasts = $('#toasts');
    function toast(type, title, msg, timeout=3200){
      const el = document.createElement('div');
      el.className = `toast ${type||''}`;
      el.style.setProperty('--toast-timeout', timeout+'ms');
      el.innerHTML = `
        <div aria-hidden="true" style="font-size:20px;margin-top:2px;">
          ${ type==='error'?'❌': type==='warn'?'⚠️': type==='success'?'✅':'ℹ️' }
        </div>
        <div>
          <div class="title">${title||''}</div>
          <div class="msg">${msg||''}</div>
        </div>
        <button class="close" aria-label="Fechar">×</button>
        <div class="bar" aria-hidden="true"></div>
      `;
      const rm = () => el.remove();
      el.querySelector('.close').addEventListener('click', rm);
      setTimeout(rm, timeout+600);
      toasts.appendChild(el);
    }

    // ========= Audio Beep (Web Audio) =========
    function beep(freq=1000, duration=180, volume=0.2){
      try{
        const Ctx = window.AudioContext || window.webkitAudioContext;
        const ctx = new Ctx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.value = freq;
        gain.gain.value = volume;
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start();
        setTimeout(()=>{ osc.stop(); ctx.close(); }, duration);
      }catch(e){ console.log('BIP!'); }
    }

    // ========= Cabeçalho/Tema =========
    $('#btnTheme').addEventListener('click', ()=>{
      state.theme = state.theme==='auto' ? 'dark' : state.theme==='dark' ? 'light' : 'auto';
      applyTheme(); save();
    });

    // ========= Modal/Abas =========
    const panel = $('#configPanel');
    $('#btnConfig').addEventListener('click', ()=> panel.style.display='block');
    $('#closeConfig').addEventListener('click', ()=> panel.style.display='none');
    panel.addEventListener('click', (e)=>{ if(e.target===panel) panel.style.display='none'; });

    $$('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        $$('.tab').forEach(x=>x.classList.remove('active'));
        $$('.tab-pane').forEach(p=>p.classList.remove('active'));
        tab.classList.add('active');
        $('#pane-'+tab.dataset.tab).classList.add('active');
      });
    });
    // sub-abas Internet
    const subAp = $('.subtab[data-subtab="ap"]');
    const subSta= $('.subtab[data-subtab="sta"]');
    subAp.addEventListener('click', ()=>{
      subAp.classList.add('active'); subSta.classList.remove('active');
      $('#subpane-ap').style.display='block'; $('#subpane-sta').style.display='none';
    });
    subSta.addEventListener('click', ()=>{
      subSta.classList.add('active'); subAp.classList.remove('active');
      $('#subpane-sta').style.display='block'; $('#subpane-ap').style.display='none';
    });

    // ========= Restaurar =========
    $('#btnReset').addEventListener('click', ()=>{
      if(confirm('Restaurar configurações padrão? Isso limpará os dados salvos neste navegador.')){
        localStorage.removeItem(LS_KEY);
        Object.assign(state, structuredClone(defaults));
        initUI();
        toast('success','Configurações','Padrões restaurados.');
      }
    });

    // ========= Internet (Wi‑Fi) =========
    const ap_ssid = $('#ap_ssid'), ap_pass = $('#ap_pass');
    const sta_ssid = $('#sta_ssid'), sta_pass = $('#sta_pass');

    function syncWifiUI(){
      ap_ssid.value = state.wifi.ap.ssid||'';
      ap_pass.value = state.wifi.ap.pass||'';
      sta_ssid.value = state.wifi.sta.ssid||'';
      sta_pass.value = state.wifi.sta.pass||'';
    }

    // Salvar AP
    $('#saveAP')?.addEventListener('click', ()=>{
      const ssid = (ap_ssid?.value || '').trim() || 'EXAUSTOR_AP';
      const pass = ap_pass?.value || '';
      if(pass && pass.length<8){ toast('warn','AP','A senha do AP deve ter pelo menos 8 caracteres.'); return; }
      state.wifi.ap = { ssid, pass }; save();
      toast('success','AP','Configuração do AP salva.');
    });

    // Salvar STA
    $('#saveSTA')?.addEventListener('click', ()=>{
      const ssid = (sta_ssid?.value || '').trim();
      const pass = (sta_pass?.value || '');
      if((ssid || pass) && pass.length<8){ toast('warn','Wi‑Fi','A senha do Wi‑Fi deve ter pelo menos 8 caracteres.'); return; }
      state.wifi.sta = { ssid, pass }; save();
      toast('success','Wi‑Fi','Configuração do cliente salva.');
    });

    // ========= Notificações =========
    function syncNotifUI(){
      $('#tempEnabled').checked = state.notif.temp.enabled;
      $('#tempBip').checked     = state.notif.temp.bip;
      $('#tempLed').checked     = state.notif.temp.led;
      $('#tempMin').value       = state.notif.temp.min;
      $('#tempMax').value       = state.notif.temp.max;

      $('#fanEnabled').checked = state.notif.fan.enabled;
      $('#fanBip').checked     = state.notif.fan.bip;
      $('#fanLed').checked     = state.notif.fan.led;
      $('#fanMin').value       = state.notif.fan.min;
      $('#fanMax').value       = state.notif.fan.max;
    }
    [
      ['tempEnabled','temp','enabled'],
      ['tempBip','temp','bip'],
      ['tempLed','temp','led'],
      ['fanEnabled','fan','enabled'],
      ['fanBip','fan','bip'],
      ['fanLed','fan','led'],
    ].forEach(([id, grp, key])=>{
      $('#'+id).addEventListener('change', ()=>{ state.notif[grp][key] = $('#'+id).checked; save(); fanChart?.update(); });
    });
    [
      ['tempMin','temp','min'], ['tempMax','temp','max'],
      ['fanMin','fan','min'],   ['fanMax','fan','max'],
    ].forEach(([id, grp, key])=>{
      $('#'+id).addEventListener('input', ()=>{
        const v = Number($('#'+id).value);
        if(Number.isFinite(v)){ state.notif[grp][key] = v; save(); fanChart?.update(); }
      });
    });

    // ========= Ventilação (Duty) =========
    const dutyInput = $('#duty');
    function syncDutyUI(){
      dutyInput.value = state.duty;
      $('#dutyVal').textContent = String(state.duty);
      $('#dutyValCfg').textContent = String(state.duty);
      $('#testDuty').value = state.duty;
      $('#testDutyVal').textContent = String(state.duty);
    }
    dutyInput.addEventListener('input', ()=>{
      state.duty = Number(dutyInput.value)||0;
      $('#dutyVal').textContent = String(state.duty);
      $('#dutyValCfg').textContent = String(state.duty);
      $('#testDuty').value = state.duty;
      $('#testDutyVal').textContent = String(state.duty);
      save();
    });

    // ========= LED (apenas teste) =========
    function renderLED(){
      const el = $('#ledStatusTest');
      if(!el) return;
      el.textContent = state.ledOn ? 'LIGADO' : 'DESLIGADO';
      el.style.color = state.ledOn ? 'var(--primary)' : 'var(--muted)';
    }
    function blinkLED(){
      const prev = state.ledOn; state.ledOn = true; renderLED();
      setTimeout(()=>{ state.ledOn = prev; renderLED(); }, 350);
    }

    // ========= Teste =========
    $('#btnBeep').addEventListener('click', ()=>{ beep(); toast('info','Teste','Bip executado'); });
    $('#btnLedOn').addEventListener('click', ()=>{ state.ledOn=true; renderLED(); save(); toast('success','LED','Acendido'); });
    $('#btnLedOff').addEventListener('click', ()=>{ state.ledOn=false; renderLED(); save(); toast('info','LED','Apagado'); });
    $('#btnLedBlink').addEventListener('click', ()=>{ blinkLED(); toast('info','LED','Piscou'); });

    $('#btnFanOn').addEventListener('click', ()=>{ state.fanOn = true; save(); toast('success','Exaustor','Ligado'); });
    $('#btnFanOff').addEventListener('click', ()=>{ state.fanOn = false; save(); toast('info','Exaustor','Desligado'); });
    $('#btnFanMin').addEventListener('click', ()=> setDuty(0, 'Exaustor em 0%'));
    $('#btnFanMax').addEventListener('click', ()=> setDuty(100, 'Exaustor em 100%'));

    const testDuty = $('#testDuty');
    testDuty.addEventListener('input', ()=>{ setDuty(Number(testDuty.value)||0); });

    function setDuty(val, msg){
      state.duty = Math.max(0, Math.min(100, val));
      $('#dutyVal').textContent = String(state.duty);
      $('#dutyValCfg').textContent = String(state.duty);
      $('#testDutyVal').textContent = String(state.duty);
      dutyInput.value = state.duty;
      testDuty.value  = state.duty;
      save();
      if(msg) toast('info','Velocidade', msg);
    }

    $('#btnSendMsg').addEventListener('click', ()=>{
      const msg = ($('#testMsg').value || '').trim();
      if(!msg){ toast('warn','Mensagem','Digite um texto para enviar'); return; }
      toast('success','Mensagem de teste', msg);
      $('#testMsg').value = '';
    });

    // ========= Util cores e gradientes =========
    const css = k => getComputedStyle(root).getPropertyValue(k).trim();
    const alpha = (hex, a=0.25) => {
      const m = hex.replace('#','');
      const bigint = parseInt(m.length===3 ? m.split('').map(x=>x+x).join('') : m, 16);
      const r = (bigint >> 16) & 255, g = (bigint >> 8) & 255, b = bigint & 255;
      return `rgba(${r},${g},${b},${a})`;
    };

    function makeGradients(ctx, baseHex){
      const {top,bottom} = ctx.chart.chartArea;
      const gradLine = ctx.createLinearGradient(0, top, 0, bottom);
      gradLine.addColorStop(0, baseHex);
      gradLine.addColorStop(1, baseHex);
      const gradFill = ctx.createLinearGradient(0, top, 0, bottom);
      gradFill.addColorStop(0, alpha(baseHex, .25));
      gradFill.addColorStop(1, alpha(baseHex, .02));
      return { line: gradLine, fill: gradFill };
    }

    // ========= Plugins de visual =========
    // Sombra suave nas linhas
    const shadowLinePlugin = {
      id: 'shadowLine',
      beforeDatasetsDraw(chart, args, opts){
        const {ctx} = chart;
        chart.data.datasets.forEach((ds, i)=>{
          if(ds.type !== 'line') return;
          const meta = chart.getDatasetMeta(i);
          if(!meta?.dataset) return;
          ctx.save();
          ctx.shadowColor = alpha('#000000', chart.options.elements?.line?.shadowOpacity ?? 0.35);
          ctx.shadowBlur  = chart.options.elements?.line?.shadowBlur ?? 14;
          ctx.shadowOffsetY = 6;
          meta.dataset.draw(ctx, args, meta.data);
          ctx.restore();
        });
        // Impede duplicar traço: escondemos stroke padrão na fase principal e redesenhamos aqui
        chart.getDatasetMeta(0)?.dataset?.options && (chart.getDatasetMeta(0).dataset.options.borderColor = 'transparent');
        chart.getDatasetMeta(1)?.dataset?.options && (chart.getDatasetMeta(1).dataset.options.borderColor = 'transparent');
      }
    };

    // Banda de faixa (min–máx) para RPM
    const rpmBandPlugin = {
      id:'rpmBand',
      beforeDatasetsDraw(chart){
        if(chart.canvas.id !== 'fanChart') return;
        if(!state.notif.fan.enabled) return;
        const {min, max} = state.notif.fan;
        const y = chart.scales.y, area = chart.chartArea, ctx = chart.ctx;
        const yTop = y.getPixelForValue(max);
        const yBot = y.getPixelForValue(min);
        ctx.save();
        ctx.fillStyle = alpha(css('--ch-rpm'), .12);
        ctx.fillRect(area.left, Math.min(yTop,yBot), area.right-area.left, Math.abs(yBot-yTop));
        ctx.restore();
      }
    };

    // Tooltip externo estilizado (baseado em exemplo oficial do Chart.js)
    const tooltipEl = document.createElement('div');
    tooltipEl.style.cssText = 'position:absolute; pointer-events:none; transform:translate(-50%, -110%); background:var(--surface); color:var(--text); border:1px solid var(--grid); padding:8px 10px; border-radius:10px; box-shadow:var(--shadow); z-index:9999; opacity:0;';
    document.body.appendChild(tooltipEl);

    function externalTooltipHandler(context){
      const {chart, tooltip} = context;
      if(tooltip.opacity === 0){ tooltipEl.style.opacity = 0; return; }
      const bodyLines = tooltip.body?.map(b => b.lines) || [];
      const title = tooltip.title?.[0] ?? '';
      const colors = tooltip.labelColors || [];
      const html = bodyLines.map((lines, i)=>{
        const c = colors[i]?.borderColor || '#888';
        return `<div style="display:flex;align-items:center;gap:8px;margin:2px 0;">
                  <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${c}"></span>
                  <span>${lines[0]}</span>
                </div>`;
      }).join('');
      tooltipEl.innerHTML = `<div style="font-weight:800;margin-bottom:4px">${title || 'Leitura'}</div>${html}`;
      const {offsetLeft: posX, offsetTop: posY} = chart.canvas;
      tooltipEl.style.left = posX + tooltip.caretX + 'px';
      tooltipEl.style.top  = posY + tooltip.caretY + 'px';
      tooltipEl.style.opacity = 1;
    }

    // ========= Gráficos (modernos) =========
    const labels = Array.from({length:42}, (_,i)=> i);
    const tempData = Array(labels.length).fill(28);
    const humData  = Array(labels.length).fill(55);
    const rpmData  = Array(labels.length).fill(600);

    const baseOpts = (yMin, yMax, yLabel) => ({
      responsive:true,
      maintainAspectRatio:false,
      animation:{ duration:350, easing:'easeOutCubic' },
      layout:{ padding:{ left:4, right:6, top:8, bottom:2 } },
      scales:{
        x:{ display:false, grid:{ display:false }, ticks:{ color: css('--tick') } },
        y:{ min:yMin, max:yMax, grid:{ color: css('--grid'), borderDash:[4,4] }, ticks:{ color: css('--tick') } }
      },
      plugins:{
        legend:{ display:false },
        tooltip:{ enabled:false, external: externalTooltipHandler, mode:'index', intersect:false },
        decimation:{ enabled:true, algorithm:'lttb', samples:42 }
      },
      elements:{
        line:{
          borderWidth:2.5,
          cubicInterpolationMode:'monotone',
          capBezierPoints:true,
          shadowBlur:14,
          shadowOpacity:.35
        },
        point:{ radius:0, hoverRadius:4, hitRadius:8 }
      }
    });

    // Criação com gradientes por canvas (e sombra)
    let tempChart, humChart, fanChart;

    function createModernCharts(){
      // Temperatura
      tempChart = new Chart($('#tempChart').getContext('2d'), {
        type:'line',
        data:{ labels, datasets:[{
          label:'Temperatura',
          data: tempData,
          borderColor: css('--ch-temp'),
          backgroundColor: alpha(css('--ch-temp'), .22),
          fill:true
        }]},
        options: baseOpts(0, 100, '°C'),
        plugins: [shadowLinePlugin]
      });

      // Umidade
      humChart = new Chart($('#humChart').getContext('2d'), {
        type:'line',
        data:{ labels, datasets:[{
          label:'Umidade',
          data: humData,
          borderColor: css('--ch-hum'),
          backgroundColor: alpha(css('--ch-hum'), .22),
          fill:true
        }]},
        options: baseOpts(0, 100, '%UR'),
        plugins: [shadowLinePlugin]
      });

      // RPM + banda min–máx (quando ativo)
      fanChart = new Chart($('#fanChart').getContext('2d'), {
        type:'line',
        data:{ labels, datasets:[{
          label:'Exaustor (RPM)',
          data: rpmData,
          borderColor: css('--ch-rpm'),
          backgroundColor: alpha(css('--ch-rpm'), .22),
          fill:true
        }]},
        options: baseOpts(0, 5000, 'RPM'),
        plugins: [rpmBandPlugin, shadowLinePlugin]
      });

      // Reaplica gradiente dinâmico com base na altura da área
      rebuildGradients();
    }

    function rebuildGradients(){
      [tempChart, humChart, fanChart].forEach(ch=>{
        if(!ch) return;
        const ctx = ch.ctx;
        const base = ch === tempChart ? css('--ch-temp') : ch === humChart ? css('--ch-hum') : css('--ch-rpm');
        const {line, fill} = makeGradients(ctx, base);
        ch.data.datasets[0].borderColor = line;
        ch.data.datasets[0].backgroundColor = fill;
        ch.update('none');
      });
    }

    function refreshChartTheme(){
      [tempChart, humChart, fanChart].forEach(ch=>{
        if(!ch) return;
        ch.options.scales.y.grid.color  = css('--grid');
        ch.options.scales.y.ticks.color = css('--tick');
        ch.options.scales.x.ticks.color = css('--tick');
        rebuildGradients();
      });
    }

    window.addEventListener('resize', ()=>{ rebuildGradients(); });

    // ========= Alertas e Simulação =========
    const tempAlertEl = $('#tempAlert');
    const fanAlertEl  = $('#fanAlert');

    const COOLDOWN = 15000;
    let lastToast = { temp:0, fan:0 };
    let inAlert   = { temp:false, fan:false };

    function step(){
      // Simulação
      const duty = state.fanOn ? state.duty : 0;
      const noise = (Math.random()-0.5);
      const nTemp = (Math.random()-0.5)*0.8;
      const nHum  = (Math.random()-0.5)*1.4;

      const prevT = tempData.at(-1) ?? 28;
      const prevH = humData.at(-1)  ?? 55;

      const temp = clamp(prevT + nTemp, 10, 90);
      const hum  = clamp(prevH + nHum,  30, 90);
      const rpm  = Math.round(clamp(duty/100*4000 + noise*120, 0, 5000));

      push(tempData, temp); push(humData, hum); push(rpmData, rpm);

      tempChart.update('none'); humChart.update('none'); fanChart.update('none');

      $('#testRpmVal').textContent = String(rpm);

      // Alertas — temperatura
      const tCfg = state.notif.temp;
      if(tCfg.enabled && (temp < tCfg.min || temp > tCfg.max)){
        const high = temp > tCfg.max;
        const msg = high
          ? `Temperatura ALTA: ${temp.toFixed(1)}°C (máx ${tCfg.max}°C)`
          : `Temperatura BAIXA: ${temp.toFixed(1)}°C (mín ${tCfg.min}°C)`;
        tempAlertEl.textContent = '⚠ ' + msg;
        const now = Date.now();
        if(!inAlert.temp || now - lastToast.temp > COOLDOWN){
          lastToast.temp = now; inAlert.temp = true;
          toast('warn','Alerta de Temperatura', msg);
          if(tCfg.led) blinkLED();
          if(tCfg.bip) beep(1200, 120, .25);
        }
      } else {
        tempAlertEl.textContent = '—';
        inAlert.temp = false;
      }

      // Alertas — RPM
      const fCfg = state.notif.fan;
      if(fCfg.enabled && (rpm < fCfg.min || rpm > fCfg.max)){
        const high = rpm > fCfg.max;
        const msg = high
          ? `RPM ALTO: ${rpm} (máx ${fCfg.max})`
          : `RPM BAIXO: ${rpm} (mín ${fCfg.min})`;
        fanAlertEl.textContent = '⚠ ' + msg;
        const now = Date.now();
        if(!inAlert.fan || now - lastToast.fan > COOLDOWN){
          lastToast.fan = now; inAlert.fan = true;
          toast('warn','Alerta de Exaustor', msg);
          if(fCfg.led) blinkLED();
          if(fCfg.bip) beep(800, 120, .25);
        }
      } else {
        fanAlertEl.textContent = '—';
        inAlert.fan = false;
      }
    }

    function push(arr,val){ arr.push(val); if(arr.length>labels.length) arr.shift(); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    // ========= Tema (rádios) =========
    $('#th_auto').addEventListener('change', ()=>{ if($('#th_auto').checked){ state.theme='auto'; applyTheme(); save(); } });
    $('#th_dark').addEventListener('change', ()=>{ if($('#th_dark').checked){ state.theme='dark'; applyTheme(); save(); } });
    $('#th_light').addEventListener('change', ()=>{ if($('#th_light').checked){ state.theme='light'; applyTheme(); save(); } });

    function initUI(){
      applyTheme();
      syncWifiUI();
      syncNotifUI();
      syncDutyUI();
      renderLED();
      $('#testDutyVal').textContent = String(state.duty);
      createModernCharts();
    }
    initUI();
    setInterval(step, 1000);
  </script>
</body>
</html>
